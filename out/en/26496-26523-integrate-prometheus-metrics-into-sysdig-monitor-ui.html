<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<meta charset="UTF-8"></meta><meta http-equiv="x-ua-compatible" content="IE=edge"></meta><meta name="format-detection" content="telephone=no"></meta><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"></meta><meta name="search" content="default"></meta><meta name="use.ic" content="no"></meta><meta name="tocstandalone" content="yes"></meta><link href="https://fonts.googleapis.com/css?family=Roboto:300,400,700|Material+Icons" rel="stylesheet"></link><meta name="theme" content="1"></meta><meta name="search.placeholder" content="Search"></meta><meta name="search.results" content="Search results"></meta><meta name="no.search.results" content="No results found"></meta><script type="text/javascript">
var theme = '1';

			
			var versionsfile = '';


			var indexDict = new Array();
			var store = {};
			var portalLanguage = 'en';
			var enterKey = 'select';
			
			
				var fuse_threshold = 0.3;
			
					var local_csh = false;
				
			var useanchorlinks = false;
			
				useanchorlinks = true;
				
				var clicktocopy = 'Click to copy link';
				var linkcopied =  'Copied!';</script><title>Integrate Prometheus Metrics into Sysdig Monitor UI</title><link rel="stylesheet" type="text/css" href="../css/docbook.css"></link><link rel="stylesheet" type="text/css" href="../css/font-awesome.css"></link><link rel="stylesheet" type="text/css" href="../css/theme1.css"></link><link rel="stylesheet" type="text/css" href="../css/theme1-colors.css"></link><link rel="stylesheet" type="text/css" href="../css/content-theme2.css"></link><link rel="stylesheet" type="text/css" href="../css/sm-core-css.css"></link><link rel="stylesheet" type="text/css" href="../css/sm-simple.css"></link><link rel="stylesheet" type="text/css" href="../css/style-print.css"></link><link rel="stylesheet" type="text/css" href="../css/style-common.css"></link><link rel="stylesheet" type="text/css" href="../css/style-modern-tables.css"></link><link rel="stylesheet" type="text/css" href="../css/graphical-lists.css"></link><link rel="stylesheet" type="text/css" href="../css/5d01321183d45.css"></link><script src="../js/jquery-3/jquery-3.3.1.min.js" type="text/javascript"></script><script src="../js/jquery-migrate-3.0.1.min.js" type="text/javascript"></script><script src="../js/materialize.min.js" type="text/javascript"></script><script src="../js/bootstrap.min.js" type="text/javascript"></script><script src="../js/purl.js" type="text/javascript"></script><script src="../js/jquery.smartmenus.js" type="text/javascript"></script><script src="../js/html5-2-mp-common.js" type="text/javascript"></script><script src="../js/html5-2.js" type="text/javascript"></script><script src="../js/checklist.js" type="text/javascript"></script><script src="../js/clipboard.min.js" type="text/javascript"></script><script src="../js/anchorlinks.js" type="text/javascript"></script><script src="js/toc.js" type="text/javascript"></script><script src="../js/create-toc.js" type="text/javascript"></script><script src="../js/fuse.min.js" type="text/javascript"></script><script src="../js/hilitor.js" type="text/javascript"></script><script src="../js/html5.fuse.search.js" type="text/javascript"></script><script src="js/fuzzydata.js" type="text/javascript"></script><script src="../js/csh.js" type="text/javascript"></script><script src="../js/layout-custom-script.js" type="text/javascript"></script><meta xmlns:xlink="http://www.w3.org/1999/xlink" name="generator" content="Paligo"></meta><link rel="prev" href="26496-26522-integrate-node-js-application-metrics.html" title="Integrate Node.js Application Metrics"></link><link rel="next" href="26496-26524-monitor-log-files.html" title="Monitor Log Files"></link><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML" async="async"></script><link rel="icon" href="/favicon.ico" type="image/x-icon"></link><script>
				$(document).ready(function () {
				$(".mediaobject img").addClass('materialboxed');
				//Exclude images with links
				$(".mediaobject a img").removeClass('materialboxed');
				$('.materialboxed').materialbox();
				});
			</script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/googlecode.min.css"></link><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js"></script><script type="text/javascript">
				$(document).ready(function(){
				$('pre').each(function(i, block) {
				hljs.highlightBlock(block);
				});
				});
			</script></head><body class="theme1 fixed-toolbar colored-top page-toc collapsible-sidebar-nav current-toc-section-focus" data-spy="scroll" data-target=".section-nav-container" data-offset="100" data-link-prefix=""><header class="site-header"><nav class="site-header-navbar navbar navbar-fixed-top"><div class="navbar-container"><div class="navbar-header"><button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".site-sidebar" aria-expanded="false" aria-controls="navbar"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><div id="logotype-container" class="pull-left"><a class="navbar-brand" href="https://478h5m1yrfsa3bbe262u7muv-wpengine.netdna-ssl.com/wp-content/themes/sysdig/assets/images/logo-sysdig-black.svg" target="_blank"><img id="logotype-pageheader" src="../css/image/corporate-logo.png" alt="Corporate logotype" data-role="logotype" class="logo"></img></a></div></div><div id="navbar" class="navbar-collapse collapse"><ul class="top-nav-menu sm sm-simple"></ul></div></div></nav></header><div class="site-body"><div class="site-body-container"><div class="site-body-row"><aside class="site-sidebar"><div class="site-sidebar-header"><button type="button" class="navbar-toggle" aria-controls="nav-site-sidebar"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a href="https://478h5m1yrfsa3bbe262u7muv-wpengine.netdna-ssl.com/wp-content/themes/sysdig/assets/images/logo-sysdig-black.svg" target="_blank"><img id="logotype-pageheader" src="../css/image/corporate-logo.png" alt="Corporate logotype" data-role="logotype" class="logo"></img></a></div><form class="site-sidebar-search" autocomplete="off"><input type="text" class="form-control search-field" placeholder="Search" id="aa-search-input"></input></form><div id="toc-standalone-placeholder"></div></aside><div class="site-content"><h1 class="publication-title">Sysdig Documentation</h1><div class="toolbar top-nav-on"><div class="toolbar-tools"><div id="navbar" class="navbar-collapse collapse"><ul class="top-nav-menu sm sm-simple"></ul></div><div class="tool-print"><i class="fa fa-print" aria-hidden="true">print</i></div><div class="tool-search"><i class="fa fa-search" aria-hidden="true"></i></div><button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".site-sidebar" aria-expanded="false" aria-controls="navbar"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button></div></div><main><div id="top-pager"><ul class="pager"><li class="previous"><a accesskey="p" id="header-navigation-prev" class="pull-left prev visible-lg visible-md" href="26496-26522-integrate-node-js-application-metrics.html">Prev</a></li><li class="next"><a accesskey="n" id="header-navigation-next" class="pull-right next visible-lg visible-md" href="26496-26524-monitor-log-files.html">Next</a></li></ul></div><article class="topic content-container" id="content-wrapper"><div id="topic-content" class="topic-content"><div class="breadcrumb-container"><ul class="breadcrumb"><li class="breadcrumb-link">Â <span class="current-category">Sysdig Documentation</span></li><li class="breadcrumb-link"><a href="26496-26519-sysdig-integrations.html">Sysdig Integrations</a></li><li class="breadcrumb-node">Integrate Prometheus Metrics into Sysdig Monitor UI</li></ul></div><section xml:lang="en" dir="ltr" class="section original-topic lang-en original-topic" data-origin-id="UUID-62d6a660-045b-f82e-1e66-d35a58c4eb47" data-permalink="26496-26523-integrate-prometheus-metrics-into-sysdig-monitor-ui.html" data-topic-level="1" data-relative-prefix="" data-publication-date="" id="UUID-2aad7b6e-f861-6cfc-4d46-b603fa0380fc"><div class="titlepage"><div><div class="title"><h3 class="title">Integrate Prometheus Metrics into Sysdig Monitor UI</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p> <a class="link" href="26496-26523-integrate-prometheus-metrics-into-sysdig-monitor-ui.html#UUID-2aad7b6e-f861-6cfc-4d46-b603fa0380fc_id_IntegratePrometheusMetricsintoSysdigMonitorUI-Introduction" title="Introduction">Introduction</a> </p></li><li class="listitem"><p> <a class="link" href="26496-26523-integrate-prometheus-metrics-into-sysdig-monitor-ui.html#UUID-2aad7b6e-f861-6cfc-4d46-b603fa0380fc_id_IntegratePrometheusMetricsintoSysdigMonitorUI-quickstartQuickStartForKubernetesEnvironments" title="Quick Start For Kubernetes Environments"> Quick Start For Kubernetes Environments</a> </p></li><li class="listitem"><p> <a class="link" href="26496-26523-integrate-prometheus-metrics-into-sysdig-monitor-ui.html#UUID-2aad7b6e-f861-6cfc-4d46-b603fa0380fc_id_IntegratePrometheusMetricsintoSysdigMonitorUI-SummaryofFunctionality" title="Summary of Functionality"> Summary of Functionality</a> </p></li><li class="listitem"><p> <a class="link" href="26496-26523-integrate-prometheus-metrics-into-sysdig-monitor-ui.html#UUID-2aad7b6e-f861-6cfc-4d46-b603fa0380fc_id_IntegratePrometheusMetricsintoSysdigMonitorUI-Configuration" title="Configuration">Configuration</a> </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p> <a class="link" href="26496-26523-integrate-prometheus-metrics-into-sysdig-monitor-ui.html#UUID-2aad7b6e-f861-6cfc-4d46-b603fa0380fc_id_IntegratePrometheusMetricsintoSysdigMonitorUI-MainConfigParameters" title="Main Config Parameters"> Main Config Parameters</a> </p></li><li class="listitem"><p> <a class="link" href="26496-26523-integrate-prometheus-metrics-into-sysdig-monitor-ui.html#UUID-2aad7b6e-f861-6cfc-4d46-b603fa0380fc_id_IntegratePrometheusMetricsintoSysdigMonitorUI-processfilterProcessFilter" title="Process Filter"> Process Filter</a> </p></li><li class="listitem"><p> <a class="link" href="26496-26523-integrate-prometheus-metrics-into-sysdig-monitor-ui.html#UUID-2aad7b6e-f861-6cfc-4d46-b603fa0380fc_id_IntegratePrometheusMetricsintoSysdigMonitorUI-confconf" title="conf">conf</a> </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: square; "><li class="listitem"><p> <a class="link" href="26496-26523-integrate-prometheus-metrics-into-sysdig-monitor-ui.html#UUID-2aad7b6e-f861-6cfc-4d46-b603fa0380fc_id_IntegratePrometheusMetricsintoSysdigMonitorUI-AuthenticationIntegration" title="Authentication Integration"> Authentication Integration</a> </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p> <a class="link" href="26496-26523-integrate-prometheus-metrics-into-sysdig-monitor-ui.html#UUID-2aad7b6e-f861-6cfc-4d46-b603fa0380fc_id_IntegratePrometheusMetricsintoSysdigMonitorUI-confAuthenticationExample" title="conf Authentication Example"> conf Authentication Example</a> </p></li></ul></div></li></ul></div></li><li class="listitem"><p> <a class="link" href="26496-26523-integrate-prometheus-metrics-into-sysdig-monitor-ui.html#UUID-2aad7b6e-f861-6cfc-4d46-b603fa0380fc_id_IntegratePrometheusMetricsintoSysdigMonitorUI-objectsKubernetesObjects" title="Kubernetes Objects"> Kubernetes Objects</a> </p></li></ul></div></li><li class="listitem"><p> <a class="link" href="26496-26523-integrate-prometheus-metrics-into-sysdig-monitor-ui.html#UUID-2aad7b6e-f861-6cfc-4d46-b603fa0380fc_id_IntegratePrometheusMetricsintoSysdigMonitorUI-Examples" title="Examples">Examples</a> </p></li><li class="listitem"><p> <a class="link" href="26496-26523-integrate-prometheus-metrics-into-sysdig-monitor-ui.html#UUID-2aad7b6e-f861-6cfc-4d46-b603fa0380fc_id_IntegratePrometheusMetricsintoSysdigMonitorUI-histogramsHistograms" title="Histograms"> Histograms</a> </p></li><li class="listitem"><p> <a class="link" href="26496-26523-integrate-prometheus-metrics-into-sysdig-monitor-ui.html#UUID-2aad7b6e-f861-6cfc-4d46-b603fa0380fc_id_IntegratePrometheusMetricsintoSysdigMonitorUI-Logging" title="Logging">Logging</a> </p></li><li class="listitem"><p> <a class="link" href="26496-26523-integrate-prometheus-metrics-into-sysdig-monitor-ui.html#UUID-2aad7b6e-f861-6cfc-4d46-b603fa0380fc_id_IntegratePrometheusMetricsintoSysdigMonitorUI-Troubleshooting" title="Troubleshooting">Troubleshooting</a> </p></li><li class="listitem"><p> <a class="link" href="26496-26523-integrate-prometheus-metrics-into-sysdig-monitor-ui.html#UUID-2aad7b6e-f861-6cfc-4d46-b603fa0380fc_id_IntegratePrometheusMetricsintoSysdigMonitorUI-legacyLegacyPrometheusApplicationCheck" title="Legacy Prometheus Application Check"> Legacy Prometheus Application Check</a> </p></li></ul></div><h6 id="UUID-2aad7b6e-f861-6cfc-4d46-b603fa0380fc_id_IntegratePrometheusMetricsintoSysdigMonitorUI-Introduction" class="bridgehead">Introduction</h6><p>Starting with version 0.70.0, the Sysdig Monitor Agent provides rich support for automatically scraping metrics from <a class="link" href="https://prometheus.io/docs/instrumenting/exporters/" target="_blank">Prometheus exporters</a>. This article describes default behaviors and how to further configure the feature to specify which processes and ports should be targeted for scraping. See our <a class="link" href="https://sysdig.com/blog/prometheus-metrics/" target="_blank">blog post</a> for additional context on the Prometheus metric format and how such metrics are typically used.</p><div dir="ltr" class="note note"><h3 class="title">Note</h3><p>The Sysdig Monitor Agent also had rudimentary Prometheus support in versions older than 0.70.0. If you were using this functionality, see the section below on the <a class="link" href="">Legacy Prometheus Application Check</a> for important upgrade information.</p></div><h6 id="UUID-2aad7b6e-f861-6cfc-4d46-b603fa0380fc_id_IntegratePrometheusMetricsintoSysdigMonitorUI-quickstartQuickStartForKubernetesEnvironments" class="bridgehead">Quick Start For Kubernetes Environments</h6><p>Prometheus users who are already leveraging <a class="link" href="">Kubernetes Service Discovery</a> (specifically the approach in <a class="link" href="">this sample prometheus-kubernetes.yml</a>) may already have Annotations attached to their Pods that mark them as eligible for scraping. Such environments can quickly begin scraping the same metrics using the Sysdig Agent in a couple easy steps.</p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>Enable the Prometheus metrics feature in the Sysdig Agent. Assuming you are <a class="link" href="https://github.com/draios/sysdig-cloud-scripts/tree/master/agent_deploy/kubernetes" target="_blank">deploying using DaemonSets</a>, the needed config can be added to the Agent's <span class="bold bold"><strong> <code class="code">dragent.yaml</code> </strong></span> by including the following in your DaemonSet YAML (placing it in the <span class="bold bold"><strong> <code class="code">env</code> </strong></span> section for the <span class="bold bold"><strong> <code class="code">sysdig-agent</code> </strong></span> container):</p><pre class="programlisting">- name: ADDITIONAL_CONF
  value: "prometheus:\n  enabled: true"

</pre></li><li class="step"><p>Ensure the Kubernetes Pods that contain your Prometheus exporters have been deployed with the following Annotations to enable scraping (substituting the listening <span class="italic italic"> <span class="bold bold"><strong> <code class="code">exporter-TCP-port)</code> </strong></span> </span> <code class="code">: </code> </p><pre class="programlisting">spec:
  template:
    metadata:
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "exporter-TCP-port"</pre><p>The configuration above assumes your exporters use the typical endpoint called <span class="bold bold"><strong> <code class="code">/metrics</code> </strong></span>. If an exporter is using a different endpoint, this can also be specified by adding the following additional optional Annotation, substituting the <span class="italic italic"> <span class="bold bold"><strong> <code class="code">exporter-endpoint-name</code> </strong></span> </span>:</p><pre class="programlisting">
prometheus.io/path: "/exporter-endpoint-name"</pre></li></ol></div><p>If you try <a class="link" href="https://raw.githubusercontent.com/luca3m/app-examples/master/prometheus-java/prometheus-java-app.yaml" target="_blank">this Kubernetes Deployment of a simple exporter</a>, you will quickly see auto-discovered Prometheus metrics being displayed in Sysdig Monitor. You can use this working example as a basis to similarly Annotate your own exporters.</p><p>If you have Prometheus exporters not deployed in annotated Kubernetes Pods that you would like to scrape, the following sections describe the full set of options to configure the Agent to find and scrape your metrics.</p><h6 id="UUID-2aad7b6e-f861-6cfc-4d46-b603fa0380fc_id_IntegratePrometheusMetricsintoSysdigMonitorUI-SummaryofFunctionality" class="bridgehead">Summary of Functionality</h6><p>The Sysdig Monitor Agent uses its visibility to all running processes (at both the host and container levels) to find eligible targets for scraping Prometheus metrics. By default, no scraping is attempted. Once the feature is enabled, the Agent assembles a list of eligible targets in two steps:</p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>A process is determined to be eligible for possible scraping if it positively matches against a series of <span class="bold bold"><strong>Process Filter</strong></span> include/exclude rules.</p></li><li class="step"><p>The Agent will then attempt to scrape an eligible process at a <span class="bold bold"><strong> <code class="code">/metrics</code> </strong></span> endpoint on all of its listening TCP ports, unless additional configuration is present to restrict scraping to a subset of ports and/or another endpoint name.</p></li></ol></div><p>The metrics ultimately appear in the Sysdig Monitor Explore interface in the Prometheus section.</p><div class="mediaobject"><table border="0" class="image-viewport" style="cellpadding: 0; cellspacing: 0;" width="300px"><tr><td><img src="image/uuid-7a32ad37-1c23-55bc-74cd-a028e820bedd-en.png" style="max-width: 300px; " alt="247201822.png"></img></td></tr></table></div><p>Within the set of eligible processes/ports/endpoints, the Agent uses an auto-discover approach to scrape only ports that are exporting Prometheus metrics, and will stop attempting to scrape or retry on ports based on how they respond to attempts to connect and scrape them. It is therefore strongly recommended that you create a configuration that restricts the process and ports for attempted scraping to the minimum expected range for your exporters. This minimizes the potential for unintended side-effects in both the Agent and your applications due to repeated failed connection attempts.</p><h6 id="UUID-2aad7b6e-f861-6cfc-4d46-b603fa0380fc_id_IntegratePrometheusMetricsintoSysdigMonitorUI-Configuration" class="bridgehead">Configuration</h6><p>As is typical for the Agent, the default configuration for the feature is specified in <span class="bold bold"><strong> <code class="code">dragent.default.yaml</code> </strong></span>, and you can override the defaults by <a class="link" href="https://sysdigdocs.atlassian.net/wiki/spaces/Platform/pages/198934553/Understanding+the+Agent+Config+Files" target="_blank">configuring parameters</a> in the <span class="bold bold"><strong> <code class="code">dragent.yaml</code> </strong></span>. For each parameter you do not set in <span class="bold bold"><strong> <code class="code">dragent.yaml</code> </strong></span>, the defaults in <span class="bold bold"><strong> <code class="code">dragent.default.yaml</code> </strong></span> will remain in effect.</p><h4 id="UUID-2aad7b6e-f861-6cfc-4d46-b603fa0380fc_id_IntegratePrometheusMetricsintoSysdigMonitorUI-MainConfigParameters" class="bridgehead">Main Config Parameters</h4><div class="informaltable table-responsive"><table class="informaltable frame-void rules-rows"><colgroup><col></col><col></col><col></col></colgroup><thead><tr><th class="th"><p>Parameter</p></th><th class="th"><p>Default</p></th><th class="th"><p>Description</p></th></tr></thead><tbody><tr><td class="td"><p> <code class="code">enabled</code> </p></td><td class="td"><p> <code class="code">false</code> </p></td><td class="td"><p>Turns Prometheus scraping on/off.</p></td></tr><tr><td class="td"><p> <code class="code">interval</code> </p></td><td class="td"><p> <code class="code">10</code> </p></td><td class="td"><p>How often (in seconds) the Agent will scrape a port for Prometheus metrics</p></td></tr><tr><td class="td"><p> <code class="code">log_errors</code> </p></td><td class="td"><p> <code class="code">true</code> </p></td><td class="td"><p>Whether the Agent should log details on failed attempts to scrape eligible targets</p></td></tr><tr><td class="td"><p> <code class="code">max_metrics</code> </p></td><td class="td"><p> <code class="code">1000</code> </p></td><td class="td"><p>The maximum number of total Prometheus metrics that will be scraped across all targets. This value of 1000 is the maximum per-Agent, and is a separate limit from other Custom Metrics (e.g. <a class="link" href="26496-26521-integrate-statsd-metrics.html" title="Integrate StatsD Metrics">statsd</a>, <a class="link" href="26496-26520-integrate-jmx-metrics-from-java-virtual-machines.html" title="Integrate JMX Metrics from Java Virtual Machines">JMX</a>, and other <a class="link linktextconsumer" href="/document/preview/6546#UUID-c887ad94-fd13-e0c3-37a3-bc79bbc23ffa" target="_blank">Application Checks</a>).<span id="UUID-2aad7b6e-f861-6cfc-4d46-b603fa0380fc_N5d0136e761c18" class="linktextprovider linktextprovider">Integrate Applications (Default App Checks)</span></p></td></tr><tr><td class="td"><p> <code class="code">max_metrics_per_process</code> </p></td><td class="td"><p> <code class="code">100</code> </p></td><td class="td"><p>The maximum number of Prometheus metrics that the Agent will save from a single scraped target</p></td></tr><tr><td class="td"><p> <code class="code">max_tags_per_metric</code> </p></td><td class="td"><p> <code class="code">20</code> </p></td><td class="td"><p>The maximum number of tags per Prometheus metric that the Agent will save from a scraped target</p></td></tr><tr><td class="td"><p> <code class="code">histograms</code> </p></td><td class="td"><p> <code class="code">false</code> </p></td><td class="td"><p>Whether the Agent should scrape and report histogram metrics. See <a class="link" href="">the section below on histograms</a> for details.</p></td></tr><tr><td class="td"><p> <code class="code">process_filter</code> </p></td><td class="td"><p>See below</p></td><td class="td"><p>Specifies which processes may be eligible for scraping. See the <a class="link" href="">Process Filter</a> section below.</p></td></tr></tbody></table></div><h4 id="UUID-2aad7b6e-f861-6cfc-4d46-b603fa0380fc_id_IntegratePrometheusMetricsintoSysdigMonitorUI-processfilterProcessFilter" class="bridgehead">Process Filter</h4><p>The <span class="bold bold"><strong> <code class="code">process_filter</code> </strong></span> section specifies which of the processes known by an Agent may be eligible for scraping.</p><p>Note that once you specify a <span class="bold bold"><strong> <code class="code">process_filter</code> </strong></span> in your <span class="bold bold"><strong> <code class="code">dragent.yaml</code> </strong></span>, this replaces the entire Prometheus <span class="bold bold"><strong> <code class="code">process_filter</code> </strong></span> section (i.e. all rules) shown in the <span class="bold bold"><strong> <code class="code">dragent.default.yaml</code> </strong></span>.</p><p>The Process Filter is specified in a series of <span class="bold bold"><strong> <code class="code">include</code> </strong></span> and <span class="bold bold"><strong> <code class="code">exclude</code> </strong></span> rules that are evaluated top-to-bottom for each process known by an Agent. If a process matches an <span class="bold bold"><strong> <code class="code">include</code> </strong></span> rule, scraping will be attempted via a <span class="bold bold"><strong> <code class="code">/metrics</code> </strong></span> endpoint on each listening TCP port for the process, unless a <span class="bold bold"><strong> <code class="code">conf</code> </strong></span> section also appears within the rule to further restrict how the process will be scraped (see <a class="link" href="">the "conf" section</a> below).</p><p>Multiple patterns can be specified in a single rule, in which case all patterns must match for the rule to be a match (AND logic).</p><p>Within a pattern value, simple "glob" wildcarding may be used, where <span class="bold bold"><strong> <code class="code">*</code> </strong></span> matches any number of characters (including none) and <span class="bold bold"><strong> <code class="code">?</code> </strong></span> matches any single character. Note that due to YAML syntax, when using wildcards, be sure to enclose the value in quotes (<span class="bold bold"><strong> <code class="code">"*"</code> </strong></span>).</p><p>The table below describes the supported patterns in Process Filter rules. To provide realistic examples, we'll use a simple <a class="link" href="https://hub.docker.com/r/luca3m/prometheus-java-app/" target="_blank">sample Prometheus exporter</a> (source code <a class="link" href="https://github.com/luca3m/app-examples/tree/master/prometheus-java" target="_blank">here</a>) which can be deployed as a container using the Docker command line below. To help illustrate some of the configuration options, this sample exporter presents Prometheus metrics on <span class="bold bold"><strong> <code class="code">/promtheus</code> </strong></span> instead of the more common <code class="code">/metrics</code> endpoint, which will be shown in the example configurations further below.</p><pre class="programlisting"># docker run -d -p 8080:8080 \
    --label class="exporter" \
    --name my-java-app \
    luca3m/prometheus-java-app
 
# ps auxww | grep app.jar
root     11502 95.9  9.2 3745724 753632 ?      Ssl  15:52   1:42 java -jar /app.jar --management.security.enabled=false
 
# curl http://localhost:8080/prometheus
...
random_bucket{le="0.005",} 6.0
random_bucket{le="0.01",} 17.0
random_bucket{le="0.025",} 51.0
...</pre><div class="informaltable table-responsive"><table class="informaltable frame-void rules-rows"><colgroup><col></col><col></col><col></col></colgroup><thead><tr><th class="th"><p>Pattern name</p></th><th class="th"><p>Description</p></th><th class="th"><p>Example</p></th></tr></thead><tbody><tr><td class="td"><p> <code class="code">container.image</code> </p></td><td class="td"><p>Matches if the process is running inside a container running the specified image</p></td><td class="td"><p> <code class="code">- include:</code> </p><p> <code class="code"> container.image: luca3m/prometheus-java-app</code> </p></td></tr><tr><td class="td"><p> <code class="code">container.name</code> </p></td><td class="td"><p>Matches if the process is running inside a container with the specified name</p></td><td class="td"><p> <code class="code">- include:</code> </p><p> <code class="code"> container.name: my-java-app</code> </p></td></tr><tr><td class="td"><p> <code class="code">container.label.*</code> </p></td><td class="td"><p>Matches if the process is running in a container that has a Label matching the given value</p></td><td class="td"><p> <code class="code">- include:</code> </p><p> <code class="code"> container.label.class: exporter</code> </p></td></tr><tr><td class="td"><p> <code class="code">kubernetes.&lt;object&gt;.annotation.* kubernetes.&lt;object&gt;.label.*</code> </p></td><td class="td"><p>Matches if the process is attached to a Kubernetes object (Pod, Namespace, etc.) that is marked with the Annotation/Label matching the given value.</p><p>Note: This pattern does not apply to the Docker-only command-line shown above, but would instead apply if the exporter were installed as a Kubernetes Deployment using <a class="link" href="https://raw.githubusercontent.com/luca3m/app-examples/master/prometheus-java/prometheus-java-app.yaml" target="_blank">this example YAML</a>.</p><p>Note: See <a class="link" href="">the section below on Kubernetes Objects</a> for information on the full set of supported Annotations and Labels.</p></td><td class="td"><p> <code class="code">- include:</code> </p><p> <code class="code"> kubernetes.pod.annotation.prometheus.io/scrape: true</code> </p></td></tr><tr><td class="td"><p> <code class="code">process.name</code> </p></td><td class="td"><p>Matches the name of the running process</p></td><td class="td"><p> <code class="code">- include:</code> </p><p> <code class="code"> process.name: java</code> </p></td></tr><tr><td class="td"><p> <code class="code">process.cmdline</code> </p></td><td class="td"><p>Matches a command line argument</p></td><td class="td"><p> <code class="code">- include:</code> </p><p> <code class="code"> process.cmdline: "*app.jar*"</code> </p></td></tr><tr><td class="td"><p> <code class="code">port</code> </p></td><td class="td"><p>Matches if the process is listening on one or more TCP ports.</p><p>The pattern for a single rule can specify a single port as shown in this example, or a single range (e.g.<code class="code">8079-8081</code>), but does not support comma-separated lists of ports/ranges.</p><p>Note: This parameter is <span class="italic italic">only</span> used to confirm if a process is eligible for scraping based on the ports on which it is listening. For example, if a process is listening on one port for application traffic and has a second port open for exporting Prometheus metrics, it would be possible to specify the application port here (but not the exporting port), and the exporting port in the <a class="link" href=""> <span class="bold bold"><strong> <code class="code">conf</code> </strong></span> section</a> (but not the application port), and the process would be matched as eligible and the exporting port would be scraped.</p></td><td class="td"><p> <code class="code">- include:</code> </p><p> <code class="code"> port: 8080</code> </p></td></tr><tr><td class="td"><p> <code class="code">appcheck.match</code> </p></td><td class="td"><p>Matches if an <a class="link linktextconsumer" href="/document/preview/6546#UUID-c887ad94-fd13-e0c3-37a3-bc79bbc23ffa" target="_blank">Application Check</a> with the specific name or pattern is scheduled to run for the process.<span id="UUID-2aad7b6e-f861-6cfc-4d46-b603fa0380fc_N5d0136e761cad" class="linktextprovider linktextprovider">Integrate Applications (Default App Checks)</span></p></td><td class="td"><p> <code class="code">- exclude:</code> </p><p> <code class="code"> appcheck.match: "*"</code> </p></td></tr></tbody></table></div><p>Instead of the <span class="bold bold"><strong> <code class="code">include</code> </strong></span> examples shown above that would have each matched our process, due to the previously-described ability to combine multiple patterns in a single rule, the following very strict configuration would also have matched:</p><pre class="programlisting">- include:
    container.image: luca3m/prometheus-java-app
    container.name: my-java-app
    container.label.class: exporter
    process.name: java
    process.cmdline: "*app.jar*"
    port: 8080</pre><h4 id="UUID-2aad7b6e-f861-6cfc-4d46-b603fa0380fc_id_IntegratePrometheusMetricsintoSysdigMonitorUI-confconf" class="bridgehead">conf</h4><p>Each <span class="bold bold"><strong> <code class="code">include</code> </strong></span> rule in the <span class="bold bold"><strong> <code class="code">port_filter</code> </strong></span> may include a <span class="bold bold"><strong> <code class="code">conf</code> </strong></span> portion that further describes how scraping will be attempted on the eligible process. If a <span class="bold bold"><strong> <code class="code">conf</code> </strong></span> portion is not included, scraping will be attempted at a <span class="bold bold"><strong> <code class="code">/metrics</code> </strong></span> endpoint on all listening ports of the matching process. The possible settings:</p><div class="informaltable table-responsive"><table class="informaltable frame-void rules-rows"><colgroup><col></col><col></col><col></col></colgroup><thead><tr><th class="th"><p>Parameter name</p></th><th class="th"><p>Description</p></th><th class="th"><p>Example</p></th></tr></thead><tbody><tr><td class="td"><p> <code class="code">port</code> </p></td><td class="td"><p>Either a static number for a single TCP port to be scraped, or a container/Kubernetes Label name or Kubernetes Annotation specified in curly braces. If the process is running in a container that is marked with this Label or is attached to a Kubernetes object (Pod, Namespace, etc.) that is marked with this Annotation/Label, scraping will be attempted only on the port specified as the value of the Label/Annotation.</p><p>Note: The Label/Annotation to match against will not include the text shown in <span class="bold bold"><strong>red</strong></span>.</p><p>Note: See <a class="link" href="">the section below on Kubernetes Objects</a> for information on the full set of supported Annotations and Labels.</p><p>Note: If running the exporter inside a container, this should specify the port number that the exporter process in the container is listening on, not the port that the container exposes to the host.</p></td><td class="td"><p> <code class="code">port: 8080</code> </p><p>- or -</p><p> <code class="code">port: "{container.label.io.prometheus.port}" </code> </p><p>- or -</p><p> <code class="code">port: "{kubernetes.pod.annotation.prometheus.io/port}" </code> </p></td></tr><tr><td class="td"><p> <code class="code">port_filter</code> </p></td><td class="td"><p>A set of include and exclude rules that define the ultimate set of listening TCP ports for an eligible process on which scraping may be attempted. Note that the syntax is different from the <span class="bold bold"><strong> <code class="code">port</code> </strong></span> pattern option from within the higher-level include rule in the <span class="bold bold"><strong> <code class="code">process_filter</code> </strong></span>. Here a given rule can include single ports, comma-separated lists of ports (enclosed in square brackets), or contiguous port ranges (without brackets).</p></td><td class="td"><p> <code class="code">port_filter:</code> </p><p> <code class="code"> - include: 8080 </code> <code class="code"> - exclude: [9092,9200,9300] - include: 9090-9100</code> </p></td></tr><tr><td class="td"><p> <code class="code">path</code> </p></td><td class="td"><p>Either the static specification of an endpoint to be scraped, or a container/Kubernetes Label name or Kubernetes Annotation specified in curly braces. If the process is running in a container that is marked with this Label or is attached to a Kubernetes object (Pod, Namespace, etc.) that is marked with this Annotation/Label, scraping will be attempted via the endpoint specified as the value of the Label/Annotation.</p><p>If <span class="bold bold"><strong> <code class="code">path</code> </strong></span> is not specified, or specified but the Agent does not find the Label/Annotation attached to the process, the common Prometheus exporter default of <span class="bold bold"><strong> <code class="code">/metrics</code> </strong></span> will be used.</p><p>Note: A Label/Annotation to match against will not include the text shown in <span class="bold bold"><strong>red</strong></span>.</p><p>Note: See <a class="link" href="">the section below on Kubernetes Objects</a> for information on the full set of supported Annotations and Labels.</p></td><td class="td"><p> <code class="code">path: "/prometheus"</code> </p><p>- or -</p><p> <code class="code">path: "{container.label.io.prometheus.path}" </code> </p><p>- or -</p><p> <code class="code">path: "{kubernetes.pod.annotation.prometheus.io/path}" </code> </p></td></tr><tr><td class="td"><p>host</p><pre class="programlisting"></pre></td><td class="td"><p>A hostname or IP address. The default is localhost.</p></td><td class="td"><pre class="programlisting">host: 192.168.1.101
- or -
host: subdomain.example.com
- or -
host: localhost</pre></td></tr><tr><td class="td"><p> <code class="code">use_https</code> </p></td><td class="td"><p>When set to <span class="bold bold"><strong> <code class="code">true</code> </strong></span>, connectivity to the exporter will only be attempted through HTTPS instead of HTTP. It is <span class="bold bold"><strong> <code class="code">false</code> </strong></span> by default.</p><p>(Available in Agent version 0.79.0 and newer)</p></td><td class="td"><p> <code class="code">use_https: true</code> </p></td></tr><tr><td class="td"><p> <code class="code">ssl_verify</code> </p></td><td class="td"><p>When set to <span class="bold bold"><strong> <code class="code">true</code> </strong></span>, verification will be performed for the server certificates for an HTTPS connection. It is <span class="bold bold"><strong> <code class="code">false</code> </strong></span> by default. Verification was enabled by default before 0.79.0.</p><p>(Available in Agent version 0.79.0 and newer)</p></td><td class="td"><p> <code class="code">ssl_verify: true</code> </p></td></tr></tbody></table></div><h4 id="UUID-2aad7b6e-f861-6cfc-4d46-b603fa0380fc_id_IntegratePrometheusMetricsintoSysdigMonitorUI-AuthenticationIntegration" class="bridgehead">Authentication Integration</h4><p>As of agent version 0.89, Sysdig can collect Prometheus metrics from endpoints requiring authentication. Use the parameters below to enable this function.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>For username/password authentication:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p> <code class="code">username</code> </p></li><li class="listitem"><p> <code class="code">password</code> </p></li></ul></div></li><li class="listitem"><p>For authentication using a token:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p> <code class="code">auth_token_path </code> </p></li></ul></div></li><li class="listitem"><p>For certificate authentication with a certificate key:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p> <code class="code">auth_cert_path</code> </p></li><li class="listitem"><p> <code class="code">auth_key_path</code> </p></li></ul></div></li></ul></div><div dir="ltr" class="note note"><h3 class="title">Note</h3><p>Token substitution is also supported for all the authorization parameters. For instance a username can be taken from a Kubernetes annotation by specifying</p><p> <code class="code">username: "{<a class="link" href="http://kubernetes.service.annotation.prometheus.openshift.io/username" target="_blank">kubernetes.service.annotation.prometheus.openshift.io/username</a>}"</code> </p></div><h4 id="UUID-2aad7b6e-f861-6cfc-4d46-b603fa0380fc_id_IntegratePrometheusMetricsintoSysdigMonitorUI-confAuthenticationExample" class="bridgehead">conf Authentication Example</h4><p>Below is an example of the <code class="code">dragent.yaml</code> section showing all the Prometheus authentication configuration options, on OpenShift, Kubernetes, and etcd.</p><p>In this example:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The <code class="code">username/password</code> are taken from a default annotation used by OpenShift.</p></li><li class="listitem"><p>The <code class="code">auth token</code> path is commonly available in Kubernetes deployments.</p></li><li class="listitem"><p>The <code class="code">certificate</code> and <code class="code">key</code> used here for etcd may normally not be as easily accessible to the agent. In this case they were extracted from the host namespace, constructed into Kubernetes secrets, and then mounted into the agent container.</p></li></ul></div><pre class="programlisting">prometheus: 
  enabled: true
  process_filter: 
    - include: 
        port: 1936
        conf: 
            username: "{kubernetes.service.annotation.prometheus.openshift.io/username}"
            password: "{kubernetes.service.annotation.prometheus.openshift.io/password}"
    - include: 
        process.name: kubelet
        conf: 
            port: 10250
            use_https: true
            auth_token_path: "/run/secrets/kubernetes.io/serviceaccount/token"
    - include: 
        process.name: etcd
        conf: 
            port: 2379
            use_https: true
            auth_cert_path: "/run/secrets/etcd/client-cert"
            auth_key_path: "/run/secrets/etcd/client-key"</pre><h4 id="UUID-2aad7b6e-f861-6cfc-4d46-b603fa0380fc_id_IntegratePrometheusMetricsintoSysdigMonitorUI-objectsKubernetesObjects" class="bridgehead">Kubernetes Objects</h4><p>As described above, there are multiple configuration options that can be set based on auto-discovered values for Kubernetes Labels and/or Annotations. The format in each case begins with <code class="code">"kubernetes.OBJECT.annotation." </code>or <code class="code">"kubernetes.OBJECT.label."</code> where <code class="code">OBJECT</code> can be any of the following supported Kubernetes object types:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p> <code class="code">daemonSet</code> </p></li><li class="listitem"><p> <code class="code">deployment</code> </p></li><li class="listitem"><p> <code class="code">namespace</code> </p></li><li class="listitem"><p> <code class="code">node</code> </p></li><li class="listitem"><p> <code class="code">pod</code> </p></li><li class="listitem"><p> <code class="code">replicaSet</code> </p></li><li class="listitem"><p> <code class="code">replicationController</code> </p></li><li class="listitem"><p> <code class="code">service</code> </p></li><li class="listitem"><p> <code class="code">statefulset</code> </p></li></ul></div><p>The configuration text you add after the final dot becomes the name of the Kubernetes Label/Annotation that the Agent will look for. If the Label/Annotation is discovered attached to the process, the value of that Label/Annotation will be used for the configuration option.</p><p>Note that there are multiple ways for a Kubernetes Label/Annotation to be attached to a particular process. One of the simplest examples of this is the Pod-based approach shown above in the <a class="link" href="">Quick Start For Kubernetes Environments</a>. However, as an example alternative to marking at the Pod level, you could attach Labels/Annotations at the Namespace level, in which case auto-discovered configuration options would apply to all processes running in that Namespace regardless of whether they're in a Deployment, DaemonSet, ReplicaSet, etc.</p><h6 id="UUID-2aad7b6e-f861-6cfc-4d46-b603fa0380fc_id_IntegratePrometheusMetricsintoSysdigMonitorUI-Examples" class="bridgehead">Examples</h6><p>As an example that pulls together many of the configuration elements shown above, consider the default Agent configuration that's inherited from the <span class="bold bold"><strong> <code class="code">dragent.default.yaml</code> </strong></span>.</p><pre class="programlisting">prometheus:
  enabled: false
  interval: 10
  log_errors: true
  max_metrics: 1000
  max_metrics_per_process: 100
  max_tags_per_metric: 20
 
  # Filtering processes to scan. Processes not matching a rule will not
  # be scanned
  # If an include rule doesn't contain a port or port_filter in the conf
  # section, we will scan all the ports that a matching process is listening to.
  process_filter:
    - exclude:
        process.name: docker-proxy
    - exclude:
        container.image: sysdig/agent
    # special rule to exclude processes matching configured prometheus appcheck
    - exclude:
        appcheck.match: prometheus
    - include:
        container.label.io.prometheus.scrape: "true"
        conf:
            # Custom path definition
            # If the Label doesn't exist we'll still use "/metrics"
            path: "{container.label.io.prometheus.path}"
 
            # Port definition
            # - If the Label exists, only scan the given port.
            # - If it doesn't, use port_filter instead.
            # - If there is no port_filter defined, skip this process
            port: "{container.label.io.prometheus.port}"
            port_filter:
                - exclude: [9092,9200,9300]
                - include: 9090-9500
                - include: [9913,9984,24231,42004]
    - exclude:
        container.label.io.prometheus.scrape: "false"
    - include:
        kubernetes.pod.annotation.prometheus.io/scrape: true
        conf:
            path: "{kubernetes.pod.annotation.prometheus.io/path}"
            port: "{kubernetes.pod.annotation.prometheus.io/port}"
    - exclude:
        kubernetes.pod.annotation.prometheus.io/scrape: false</pre><p>Things to note about this default configuration:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Once enabled, this default configuration is ideal for the use case described above in the <a class="link" href="">Quick Start For Kubernetes Environments</a>.</p></li><li class="listitem"><p>All Prometheus scraping is disabled by default to allow for a smooth transition for users of the legacy Prometheus Application Check (see <a class="link" href="">the note below</a>). To enable the entire config shown here, you would only need to add the following to your <span class="bold bold"><strong> <code class="code">dragent.yaml</code> </strong></span>:</p><pre class="programlisting">prometheus:
  enabled: true</pre></li><li class="listitem"><p>A Process Filter rule excludes processes that are likely to exist in most environments but are known to never export Prometheus metrics, such as the Docker Proxy and the Agent itself.</p></li><li class="listitem"><p>Another Process Filter rule ensures that any processes configured to be scraped by the legacy Prometheus Application Check will not be scraped. See <a class="link" href="">the section below on the Legacy Prometheus Application Check</a> for details.</p></li><li class="listitem"><p>Another Process Filter rule is tailored to use of container Labels. Processes marked with the container Label <span class="bold bold"><strong> <code class="code">io.prometheus.scrape</code> </strong></span> will become eligible for scraping, and if further marked with container Labels <span class="bold bold"><strong> <code class="code">io.prometheus.port</code> </strong></span> and/or <span class="bold bold"><strong> <code class="code">io.prometheus.path</code> </strong></span>, scraping will be attempted only on this port and/or endpoint. If the container is not marked with the specified path Label, scraping the <span class="bold bold"><strong> <code class="code">/metrics</code> </strong></span> endpoint will be attempted. If the container is not marked with the specified port Label, any listening ports in the <span class="bold bold"><strong> <code class="code">port_filter</code> </strong></span> will be attempted for scraping (this <span class="bold bold"><strong> <code class="code">port_filter</code> </strong></span> in the default is set for the <a class="link" href="https://github.com/prometheus/prometheus/wiki/Default-port-allocations" target="_blank">range of ports for common Prometheus exporters</a>, with exclusions for ports in the range that are known to be used by other applications that are not exporters).</p></li><li class="listitem"><p>The final Process Filter include rule is tailored to the use case described above in <a class="link" href="">Quick Start For Kubernetes Environments</a>.</p></li></ul></div><p>With this default configuration enabled, a containerized install of our example exporter shown below would be automatically scraped via the Agent.</p><pre class="programlisting"># docker run -d -p 8080:8080 \
    --label io.prometheus.scrape="true" \
    --label io.prometheus.port="8080" \
    --label io.prometheus.path="/prometheus" \
    luca3m/prometheus-java-app</pre><p>Similarly, in a Kubernetes-based environment, a Deployment with the Annotations as shown in using <a class="link" href="https://raw.githubusercontent.com/luca3m/app-examples/master/prometheus-java/prometheus-java-app.yaml" target="_blank">this example YAML</a> would also be scraped by enabling the default configuration.</p><pre class="programlisting">apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: prometheus-java-app
spec:
  replicas: 1
  template:
    metadata:
      labels:
        app: prometheus-java-app
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/path: "/prometheus"
        prometheus.io/port: "8080"
    spec:
      containers:
        - name: prometheus-java-app
          image: luca3m/prometheus-java-app
          imagePullPolicy: Always

</pre><p>Finally, we'll consider an example for a non-containerized environment or a containerized environment that doesn't use Labels or Annotations. The following <span class="bold bold"><strong> <code class="code">dragent.yaml</code> </strong></span> would override the default and do per-second scrapes of our sample exporter and also a second exporter on port 5005, each at their respective non-standard endpoints. This can be thought of as a conservative "whitelist" type of configuration since it restricts scraping to only exporters that are known to exist in the environment and the ports on which they're known to export Prometheus metrics.</p><pre class="programlisting">prometheus:
  enabled: true
  interval: 1
  process_filter:
    - include:
        process.cmdline: "*app.jar*"
        conf:
          port: 8080
          path: "/prometheus"
    - include:
        port: 5005
        conf:
          port: 5005
          path: "/wacko"</pre><h6 id="UUID-2aad7b6e-f861-6cfc-4d46-b603fa0380fc_id_IntegratePrometheusMetricsintoSysdigMonitorUI-histogramsHistograms" class="bridgehead">Histograms</h6><p>By default, the Agent does not scrape details for the histogram metrics reported by exporters. To enable this, include the additional <span class="bold bold"><strong> <code class="code">histograms</code> </strong></span> option:</p><pre class="programlisting">prometheus:
  enabled: true
  histograms: true</pre><p>Note that the way Prometheus histograms are typically reported by exporters, they are <a class="link" href="https://www.robustperception.io/why-are-prometheus-histograms-cumulative/" target="_blank">cumulative across buckets</a> and also report accumulations within each bucket range since the exporter started. To make this data easier to visualize, the Sysdig Monitor application presents histogram data as a delta over the selected time range. For instance, below we've had our <a class="link" href="https://hub.docker.com/r/luca3m/prometheus-java-app/" target="_blank">sample Prometheus exporter</a> running for over an hour, accumulating data in a histogram metric called random:</p><pre class="programlisting"># curl http://127.0.0.1:8080/prometheus
...
# HELP random Random sleep
# TYPE random histogram
random_bucket{le="0.005",} 33.0
random_bucket{le="0.01",} 74.0
random_bucket{le="0.025",} 180.0
random_bucket{le="0.05",} 404.0
random_bucket{le="0.075",} 639.0
random_bucket{le="0.1",} 848.0
random_bucket{le="0.25",} 2145.0
random_bucket{le="0.5",} 4307.0
random_bucket{le="0.75",} 6371.0
random_bucket{le="1.0",} 8592.0
random_bucket{le="2.5",} 8619.0
random_bucket{le="5.0",} 8619.0
random_bucket{le="7.5",} 8619.0
random_bucket{le="10.0",} 8619.0
random_bucket{le="+Inf",} 8619.0
...</pre><p>However in the Sysdig Monitor interface, if we select the metric and a time range such as 10 minutes, we'll see the per-bucket distribution for only that time range. Hover your mouse over a particular bar to see the bucket range. If this histogram metric is being reported from multiple sources, you will see the contribution to the total from each source based on your choice of <span class="bold bold"><strong>Segment by</strong></span>. In this case we are segmenting by hostname and only have one contributing source, called "ubuntu16".</p><div class="mediaobject"><table border="0" class="image-viewport" style="cellpadding: 0; cellspacing: 0;" width="1024px"><tr style="height: 667px"><td><img src="image/uuid-d4a93b58-5fc4-1cc6-a6a2-b7d4b80abd74-en.png" style="max-width: 1024px; max-height: 667px; " alt="247300103.png"></img></td></tr></table></div><h6 id="UUID-2aad7b6e-f861-6cfc-4d46-b603fa0380fc_id_IntegratePrometheusMetricsintoSysdigMonitorUI-Logging" class="bridgehead">Logging</h6><p>After the Agent begins scraping Prometheus metrics, there may be a delay of up to a few minutes before the metrics become visible in Sysdig Monitor. To help quickly confirm your configuration is correct, starting with Agent version 0.80.0, the following log line will appear in the Agent log the first time since since starting that it has found and is successfully scraping at least one Prometheus exporter:</p><pre class="programlisting">
2018-05-04 21:42:10.048, 8820, Information, 05-04 21:42:10.048324 Starting export of Prometheus metrics</pre><p>As this is an INFO level log message, it will appear in Agents using the default logging settings. To reveal even more detail, <a class="link" href="https://sysdigdocs.atlassian.net/wiki/spaces/Platform/pages/234094780/Optional%3A+Change+the+Agent+Log+Level" target="_blank">increase the Agent log level to DEBUG</a>, which produces a message like the following that reveals the name of a specific metric first detected. You can then look for this metric to be visible in Sysdig Monitor shortly after.</p><pre class="programlisting">
2018-05-04 21:50:46.068, 11212, Debug, 05-04 21:50:46.068141 First prometheus metrics since agent start: pid 9583: 5 metrics including: randomSummary.95percentile</pre><h6 id="UUID-2aad7b6e-f861-6cfc-4d46-b603fa0380fc_id_IntegratePrometheusMetricsintoSysdigMonitorUI-Troubleshooting" class="bridgehead">Troubleshooting</h6><p>See the previous section for information on expected log messages during successful scraping. If you have enabled Prometheus and are not seeing the <span class="bold bold"><strong> <code class="code">Starting export</code> </strong></span> message shown there, revisit your configuration.</p><p>It is also suggested to leave the configuration option in its default setting of <span class="bold bold"><strong> <code class="code">log_errors: true</code> </strong></span>, which will reveal any issues scraping eligible processes in the Agent log.</p><p>For example, here is an error message for a failed scrape of a TCP port that was listening but not accepting HTTP requests:</p><pre class="programlisting">
2017-10-13 22:00:12.076, 4984, Error, sdchecks[4987] Exception on running check prometheus.5000: Exception('Timeout when hitting http://localhost:5000/metrics',)
2017-10-13 22:00:12.076, 4984, Error, sdchecks, Traceback (most recent call last):
2017-10-13 22:00:12.076, 4984, Error, sdchecks, File "/opt/draios/lib/python/sdchecks.py", line 246, in run
2017-10-13 22:00:12.076, 4984, Error, sdchecks, self.check_instance.check(self.instance_conf)
2017-10-13 22:00:12.076, 4984, Error, sdchecks, File "/opt/draios/lib/python/checks.d/prometheus.py", line 44, in check
2017-10-13 22:00:12.076, 4984, Error, sdchecks, metrics = self.get_prometheus_metrics(query_url, timeout, "prometheus")
2017-10-13 22:00:12.076, 4984, Error, sdchecks, File "/opt/draios/lib/python/checks.d/prometheus.py", line 105, in get_prometheus_metrics
2017-10-13 22:00:12.077, 4984, Error, sdchecks, raise Exception("Timeout when hitting %s" % url)
2017-10-13 22:00:12.077, 4984, Error, sdchecks, Exception: Timeout when hitting http://localhost:5000/metrics</pre><p>Here is an example error message for a failed scrape of a port that was responding to HTTP requests on the <span class="bold bold"><strong> <code class="code">/metrics</code> </strong></span> endpoint but not responding with valid Prometheus-format data. The invalid endpoint is responding as follows:</p><pre class="programlisting"># curl http://localhost:5002/metrics
This ain't no Prometheus metrics!</pre><p>And the corresponding error message in the Agent log, indicating no further scraping will be attempted after the initial failure:</p><pre class="programlisting">
2017-10-13 22:03:05.081, 5216, Information, sdchecks[5219] Skip retries for Prometheus error: could not convert string to float: ain't
2017-10-13 22:03:05.082, 5216, Error, sdchecks[5219] Exception on running check prometheus.5002: could not convert string to float: ain't</pre><h6 id="UUID-2aad7b6e-f861-6cfc-4d46-b603fa0380fc_id_IntegratePrometheusMetricsintoSysdigMonitorUI-legacyLegacyPrometheusApplicationCheck" class="bridgehead">Legacy Prometheus Application Check</h6><p>Special care should be taken if you're already using the <span class="bold bold"><strong>legacy Prometheus Application Check</strong></span> (explained below) to scrape any Prometheus metrics. You will be able to scrape for the same metrics using the new approach and they will appear in Sysdig Monitor under the same metric name. However, any historical data from when it was collected via the legacy Prometheus App Check will no longer be visible. As a result, the new approach is disabled by default, and you should carefully plan your transition to using the new approach for each set of metrics when you feel you can endure the break with historical data.</p><p>The <span class="bold bold"><strong>legacy Prometheus application check</strong></span> is able to collect metrics from a static external HTTP endpoint exposing metrics in Prometheus format and import them as StatsD metrics in Sysdig.</p><p>To configure the legacy Prometheus application check, Add these lines to the agent's configuration file:</p><pre class="programlisting">app_checks:
  - name: prometheus
    pattern:
      comm: python
      arg: /opt/draios/bin/sdchecks
    conf:
      url: http://{YOUR_PROMETHEUS_ENDPOINT_IP}:8080/metrics</pre></section><div class="footer-content"><div class="section-toc section-toc-after"><div class="section-toc-title">In this section<span class="section-toc-title-delimiter">: </span></div></div><div class="glossary-definitions"></div></div><footer></footer></div></article><article id="search-result-wrapper"><div class="search-container" style="display: none;"><h2>Search results</h2><ul class="searchresults"></ul><p class="noresults">No results found</p></div></article></main><div id="bottom-pager"><ul class="pager"><li class="previous"><a accesskey="p" id="header-navigation-prev" class="pull-left prev visible-lg visible-md" href="26496-26522-integrate-node-js-application-metrics.html">Prev</a></li><li class="next"><a accesskey="n" id="header-navigation-next" class="pull-right next visible-lg visible-md" href="26496-26524-monitor-log-files.html">Next</a></li></ul></div><footer class="site-footer"><div class="inner"><div class="copyright"> Â© 2019 Sysdig </div><div class="publication-date"><span class="publication-date-text">Publication date</span><span class="pubdate-delimiter">: </span><span class="formatted-date"></span></div></div></footer></div></div></div></div></body></html>
