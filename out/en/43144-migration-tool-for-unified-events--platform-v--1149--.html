<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<meta charset="UTF-8"></meta><meta http-equiv="x-ua-compatible" content="IE=edge"></meta><meta name="format-detection" content="telephone=no"></meta><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"></meta><meta name="search" content="default"></meta><meta name="use.ic" content="no"></meta><meta name="tocstandalone" content="no"></meta><link href="https://fonts.googleapis.com/css?family=Roboto:300,400,700|Material+Icons" rel="stylesheet"></link><meta name="theme" content="1"></meta><meta name="search.placeholder" content="Search"></meta><meta name="search.results" content="Search results"></meta><meta name="no.search.results" content="No results found"></meta><script type="text/javascript">
var theme = '1';

			
			var versionsfile = '';


			var indexDict = new Array();
			var store = {};
			var portalLanguage = 'en';
			var enterKey = 'select';
			
			
				var fuse_threshold = 0.3;
			
					var local_csh = false;
				
			var useanchorlinks = false;
			
				useanchorlinks = true;
				
				var clicktocopy = 'Click to copy link';
				var linkcopied =  'Copied!';</script><title>Migration Tool for Unified Events (Platform v. 1149+)</title><link rel="stylesheet" type="text/css" href="../css/docbook.css"></link><link rel="stylesheet" type="text/css" href="../css/font-awesome.css"></link><link rel="stylesheet" type="text/css" href="../css/theme1.css"></link><link rel="stylesheet" type="text/css" href="../css/theme1-colors.css"></link><link rel="stylesheet" type="text/css" href="../css/content-theme2.css"></link><link rel="stylesheet" type="text/css" href="../css/sm-core-css.css"></link><link rel="stylesheet" type="text/css" href="../css/sm-simple.css"></link><link rel="stylesheet" type="text/css" href="../css/style-print.css"></link><link rel="stylesheet" type="text/css" href="../css/style-common.css"></link><link rel="stylesheet" type="text/css" href="../css/style-modern-tables.css"></link><link rel="stylesheet" type="text/css" href="../css/graphical-lists.css"></link><link rel="stylesheet" type="text/css" href="../css/5d6593bb1e613.css"></link><script src="../js/jquery-3/jquery-3.4.1.min.js" type="text/javascript"></script><script src="../js/jquery-migrate-3.0.1.min.js" type="text/javascript"></script><script src="../js/materialize.min.js" type="text/javascript"></script><script src="../js/bootstrap.min.js" type="text/javascript"></script><script src="../js/purl.js" type="text/javascript"></script><script src="../js/jquery.smartmenus.js" type="text/javascript"></script><script src="../js/html5-2-mp-common.js" type="text/javascript"></script><script src="../js/html5-2.js" type="text/javascript"></script><script src="../js/checklist.js" type="text/javascript"></script><script src="../js/clipboard.min.js" type="text/javascript"></script><script src="../js/anchorlinks.js" type="text/javascript"></script><script src="../js/fuse.min.js" type="text/javascript"></script><script src="../js/hilitor.js" type="text/javascript"></script><script src="../js/html5.fuse.search.js" type="text/javascript"></script><script src="js/fuzzydata.js" type="text/javascript"></script><script src="../js/csh.js" type="text/javascript"></script><script src="../js/layout-custom-script.js" type="text/javascript"></script><meta xmlns:xlink="http://www.w3.org/1999/xlink" name="generator" content="Paligo"></meta><link rel="prev" href="43140-on-premises-upgrades.html#UUID-360704d7-d3e0-7169-b074-f1990f6603ef_UUID-0012eee4-642c-c9dd-5b8c-9498c30246b2" title="For Replicated Upgrades"></link><link rel="next" href="43144-migration-tool-for-unified-events--platform-v--1149--.html#UUID-fe016e20-229b-e333-80ed-cb773dde4885_UUID-10a4178a-ada7-6842-4acb-9cbe4fba00df" title="Prerequisites"></link><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML" async="async"></script><link rel="icon" href="/favicon.ico" type="image/x-icon"></link><script>
				$(document).ready(function () {
				$(".mediaobject img").addClass('materialboxed');
				//Exclude images with links
				$(".mediaobject a img").removeClass('materialboxed');
				$('.materialboxed').materialbox();
				});
			</script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/googlecode.min.css"></link><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js"></script><script type="text/javascript">
			$(document).ready(function() {
				/**
				 * @type {array}
				 */
				var supported = hljs.listLanguages();

				$('pre:not(.embedcode)').each(function() {
					/**
					 * @type {string}
					 */
					var language = $(this).data('language');

					if (language === 'plaintext' || language === 'text') {
						$(this).addClass(language).addClass('hljs');
						return true;
					}

					if (language && $.inArray(language, supported) > -1) {
						var c = hljs.highlight(language, $(this).text());
						$(this)
							.empty()
							.append(c.value)
							.addClass("hljs")
							.addClass(c.language);
					} else {
						hljs.highlightBlock(this);
					}
				});
			});
			</script></head><body class="theme1 fixed-toolbar colored-top page-toc collapsible-sidebar-nav current-toc-section-focus" data-spy="scroll" data-target=".section-nav-container" data-offset="100" data-link-prefix=""><header class="site-header"><nav class="site-header-navbar navbar navbar-fixed-top"><div class="navbar-container"><div class="navbar-header"><button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".site-sidebar" aria-expanded="false" aria-controls="navbar"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><div id="logotype-container" class="pull-left"><a class="navbar-brand" href="../index.html?lang=en"><img id="logotype-pageheader" src="../css/image/corporate-logo.png" alt="Corporate logotype" data-role="logotype" class="logo"></img></a></div></div><div id="navbar" class="navbar-collapse collapse"><ul class="top-nav-menu sm sm-simple"></ul></div></div></nav></header><div class="site-body"><div class="site-body-container"><div class="site-body-row"><aside class="site-sidebar"><div class="site-sidebar-header"><button type="button" class="navbar-toggle" aria-controls="nav-site-sidebar"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a href="../index.html?lang=en"><img id="logotype-pageheader" src="../css/image/corporate-logo.png" alt="Corporate logotype" data-role="logotype" class="logo"></img></a></div><form class="site-sidebar-search" autocomplete="off"><input type="text" class="form-control search-field" placeholder="Search" id="aa-search-input"></input></form><ul class="toc nav nav-site-sidebar"><li><a href="43019-sysdig-platform.html" class="topic-link section original-topic lang-en original-topic" data-origin-id="UUID-2aec11a7-27eb-167a-dfc2-d868c58604cd" data-permalink="43019-sysdig-platform.html" data-topic-level="1" data-relative-prefix="" data-publication-date=""><span class="glyphicon"></span> Sysdig Platform</a><ul><li><a href="43026-on-premises-deployments.html" class="topic-link section original-topic lang-en original-topic" data-origin-id="UUID-3967fd02-70a8-134b-394b-cace7214ff6d" data-permalink="43026-on-premises-deployments.html" data-topic-level="1" data-relative-prefix="" data-publication-date=""><span class="glyphicon"></span> On-Premises Deployments</a><ul><li><a href="43027-architecture---system-requirements.html" class="topic-link section original-topic lang-en original-topic" data-origin-id="UUID-dec254a6-b961-0e73-3f01-20f689cf90e3" data-permalink="43027-architecture---system-requirements.html" data-topic-level="1" data-relative-prefix="" data-publication-date="">Architecture &amp; System Requirements</a></li><li><a href="43049-on-premises-installation.html" class="topic-link section original-topic lang-en original-topic" data-origin-id="UUID-db1188d3-a7ec-15df-c6cf-67e07a21b18b" data-permalink="43049-on-premises-installation.html" data-topic-level="1" data-relative-prefix="" data-publication-date="">On-Premises Installation</a></li><li><a href="43140-on-premises-upgrades.html" class="topic-link section original-topic lang-en original-topic" data-origin-id="UUID-5d758c36-dfff-2452-850d-9ed2a4371f81" data-permalink="43140-on-premises-upgrades.html" data-topic-level="1" data-relative-prefix="" data-publication-date="">On-Premises Upgrades</a></li><li><a href="43209-find-the-super-admin-credentials-and-api-token.html" class="topic-link section original-topic lang-en original-topic" data-origin-id="UUID-8dab9961-ec84-3db6-d190-6869ea677fc0" data-permalink="43209-find-the-super-admin-credentials-and-api-token.html" data-topic-level="1" data-relative-prefix="" data-publication-date="">Find the Super Admin Credentials and API Token</a></li><li><a href="43212-upgrade-an-on-premises-license.html" class="topic-link section original-topic lang-en original-topic" data-origin-id="UUID-7887f7e8-616a-7c82-1e15-4faca9d5c58f" data-permalink="43212-upgrade-an-on-premises-license.html" data-topic-level="1" data-relative-prefix="" data-publication-date="">Upgrade an On-Premises License</a></li><li><a href="43217-securing-elasticsearch.html" class="topic-link section original-topic lang-en original-topic" data-origin-id="UUID-98444088-953d-f9e0-cccd-ae3d2cabdc82" data-permalink="43217-securing-elasticsearch.html" data-topic-level="1" data-relative-prefix="" data-publication-date="">Securing Elasticsearch</a></li><li><a href="43222-securing-cassandra.html" class="topic-link section original-topic lang-en original-topic" data-origin-id="UUID-d6bd8eba-9fca-4113-e123-10a2f1a3a374" data-permalink="43222-securing-cassandra.html" data-topic-level="1" data-relative-prefix="" data-publication-date="">Securing Cassandra</a></li><li><a href="43230-authentication-and-authorization--on-prem-options-.html" class="topic-link section original-topic lang-en original-topic" data-origin-id="UUID-648140d5-4cd3-49eb-c672-21e00ae3296c" data-permalink="43230-authentication-and-authorization--on-prem-options-.html" data-topic-level="1" data-relative-prefix="" data-publication-date="">Authentication and Authorization (On-Prem Options)</a></li></ul></li><li><a href="43297-sysdig-agent.html" class="topic-link section original-topic lang-en original-topic" data-origin-id="UUID-2b34ba9d-6b45-4d57-a133-ae54d956ee58" data-permalink="43297-sysdig-agent.html" data-topic-level="1" data-relative-prefix="" data-publication-date=""><span class="glyphicon"></span> Sysdig Agent</a><ul><li><a href="43298-host-requirements-for-agent-installation.html" class="topic-link section original-topic lang-en original-topic" data-origin-id="UUID-cc64bfae-70f3-b2d6-42d6-cf84ccf5abaf" data-permalink="43298-host-requirements-for-agent-installation.html" data-topic-level="1" data-relative-prefix="" data-publication-date="">Host Requirements for Agent Installation</a></li><li><a href="43317-agent-installation.html" class="topic-link section original-topic lang-en original-topic" data-origin-id="UUID-ef0cd1a8-cec3-1ed9-65b7-d2b61ce9d78f" data-permalink="43317-agent-installation.html" data-topic-level="1" data-relative-prefix="" data-publication-date="">Agent Installation</a></li><li><a href="43391-agent-configuration.html" class="topic-link section original-topic lang-en original-topic" data-origin-id="UUID-07369059-d819-881f-183c-902f87b1b917" data-permalink="43391-agent-configuration.html" data-topic-level="1" data-relative-prefix="" data-publication-date="">Agent Configuration</a></li><li><a href="43450-agent-upgrade.html" class="topic-link section original-topic lang-en original-topic" data-origin-id="UUID-551eb1f0-de5e-9917-527e-ed2d7183b2b5" data-permalink="43450-agent-upgrade.html" data-topic-level="1" data-relative-prefix="" data-publication-date="">Agent Upgrade</a></li><li><a href="43457---agent-stop---start---disable---remove.html" class="topic-link section original-topic lang-en original-topic" data-origin-id="UUID-3031a485-9dec-0547-24e6-5f1e9967311f" data-permalink="43457---agent-stop---start---disable---remove.html" data-topic-level="1" data-relative-prefix="" data-publication-date="">**Agent Stop | Start | Disable | Remove</a></li><li><a href="43467-agent-uninstall.html" class="topic-link section original-topic lang-en original-topic" data-origin-id="UUID-3ccccaf4-45c2-3331-6fad-0829e683559c" data-permalink="43467-agent-uninstall.html" data-topic-level="1" data-relative-prefix="" data-publication-date="">Agent Uninstall</a></li><li><a href="43470-troubleshooting-agent-installation.html" class="topic-link section original-topic lang-en original-topic" data-origin-id="UUID-442c725a-6fb0-c992-9d42-1e253ac3d09d" data-permalink="43470-troubleshooting-agent-installation.html" data-topic-level="1" data-relative-prefix="" data-publication-date="">Troubleshooting Agent Installation</a></li></ul></li><li><a href="43478-administration-settings.html" class="topic-link section original-topic lang-en original-topic" data-origin-id="UUID-1fced76a-c05c-a3dd-6965-ac6271a0c4b0" data-permalink="43478-administration-settings.html" data-topic-level="1" data-relative-prefix="" data-publication-date=""><span class="glyphicon"></span> Administration Settings</a><ul><li><a href="43481-user-profile-and-password.html" class="topic-link section original-topic lang-en original-topic" data-origin-id="UUID-68bae3d5-4e67-564d-a56f-36849de2841e" data-permalink="43481-user-profile-and-password.html" data-topic-level="1" data-relative-prefix="" data-publication-date="">User Profile and Password</a></li><li><a href="43489-user-and-team-administration.html" class="topic-link section original-topic lang-en original-topic" data-origin-id="UUID-00849bf9-2afa-6f2d-7293-ccb78c36cded" data-permalink="43489-user-and-team-administration.html" data-topic-level="1" data-relative-prefix="" data-publication-date="">User and Team Administration</a></li><li><a href="43512-notifications-management.html" class="topic-link section original-topic lang-en original-topic" data-origin-id="UUID-53d9d5a5-68f8-e49a-3dd2-ec0444ad3597" data-permalink="43512-notifications-management.html" data-topic-level="1" data-relative-prefix="" data-publication-date="">Notifications Management</a></li><li><a href="43548-aws--integrate-aws-account-and-cloudwatch-metrics--optional-.html" class="topic-link section original-topic lang-en original-topic" data-origin-id="UUID-5c2df7a4-a53f-28fd-1303-29a41a587a6f" data-permalink="43548-aws--integrate-aws-account-and-cloudwatch-metrics--optional-.html" data-topic-level="1" data-relative-prefix="" data-publication-date="">AWS: Integrate AWS Account and CloudWatch Metrics (Optional)</a></li><li><a href="43563-storage--configure-aws-capture-file-storage--optional-.html" class="topic-link section original-topic lang-en original-topic" data-origin-id="UUID-bdc495d5-e851-5fb6-ed62-07eb12e45024" data-permalink="43563-storage--configure-aws-capture-file-storage--optional-.html" data-topic-level="1" data-relative-prefix="" data-publication-date="">Storage: Configure AWS Capture File Storage (Optional)</a></li><li><a href="43568-find-your-customer-number.html" class="topic-link section original-topic lang-en original-topic" data-origin-id="UUID-7e5c73de-e0be-9643-6660-81ee98d1dee6" data-permalink="43568-find-your-customer-number.html" data-topic-level="1" data-relative-prefix="" data-publication-date="">Find Your Customer Number</a></li><li><a href="43569-agent-installation--overview-and-key.html" class="topic-link section original-topic lang-en original-topic" data-origin-id="UUID-8abc0bd0-5c58-5ddf-3912-b84f3e85b884" data-permalink="43569-agent-installation--overview-and-key.html" data-topic-level="1" data-relative-prefix="" data-publication-date="">Agent Installation: Overview and Key</a></li><li><a href="43571-subscription--change-number-of-licensed-agents.html" class="topic-link section original-topic lang-en original-topic" data-origin-id="UUID-aa6b5487-52a8-155d-a66f-bb4123d2a4fe" data-permalink="43571-subscription--change-number-of-licensed-agents.html" data-topic-level="1" data-relative-prefix="" data-publication-date="">Subscription: Change Number of Licensed Agents</a></li><li><a href="43579-authentication-and-authorization--saas-.html" class="topic-link section original-topic lang-en original-topic" data-origin-id="UUID-a01b3e9a-2bed-30ad-b321-61f47790c80e" data-permalink="43579-authentication-and-authorization--saas-.html" data-topic-level="1" data-relative-prefix="" data-publication-date="">Authentication and Authorization (SaaS)</a></li></ul></li><li><a href="43623-get-help---using-sysdig-support.html" class="topic-link section original-topic lang-en original-topic" data-origin-id="UUID-cfa5bd5d-97db-98f6-7a2f-e76376c865d7" data-permalink="43623-get-help---using-sysdig-support.html" data-topic-level="1" data-relative-prefix="" data-publication-date=""><span class="glyphicon"></span> Get Help | Using Sysdig Support</a><ul><li><a href="43624-self-help.html" class="topic-link section original-topic lang-en original-topic" data-origin-id="UUID-2a9e92b7-a64a-9fe3-9ee7-cc7e463c590a" data-permalink="43624-self-help.html" data-topic-level="1" data-relative-prefix="" data-publication-date="">Self-Help</a></li><li><a href="43638-contact-support.html" class="topic-link section original-topic lang-en original-topic" data-origin-id="UUID-716a9a89-2ea4-0e43-8643-902620732467" data-permalink="43638-contact-support.html" data-topic-level="1" data-relative-prefix="" data-publication-date="">Contact Support</a></li><li><a href="43658-terms-of-use.html" class="topic-link section original-topic lang-en original-topic" data-origin-id="UUID-8f7aed46-3390-e0a1-5227-8b693b2c9acb" data-permalink="43658-terms-of-use.html" data-topic-level="1" data-relative-prefix="" data-publication-date="">Terms of Use</a></li></ul></li></ul></li></ul></aside><div class="site-content"><h1 class="publication-title">Sysdig Platform</h1><div class="toolbar top-nav-on"><div class="toolbar-tools"><div id="navbar" class="navbar-collapse collapse"><ul class="top-nav-menu sm sm-simple"></ul></div><div class="tool-print"><i class="fa fa-print" aria-hidden="true">print</i></div><div class="tool-search"><i class="fa fa-search" aria-hidden="true"></i></div><button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".site-sidebar" aria-expanded="false" aria-controls="navbar"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button></div></div><main><div id="top-pager"><ul class="pager"><li class="previous"><a accesskey="p" id="header-navigation-prev" class="pull-left prev visible-lg visible-md" href="43140-on-premises-upgrades.html#UUID-360704d7-d3e0-7169-b074-f1990f6603ef_UUID-0012eee4-642c-c9dd-5b8c-9498c30246b2">Prev</a></li><li class="next"><a accesskey="n" id="header-navigation-next" class="pull-right next visible-lg visible-md" href="43144-migration-tool-for-unified-events--platform-v--1149--.html#UUID-fe016e20-229b-e333-80ed-cb773dde4885_UUID-10a4178a-ada7-6842-4acb-9cbe4fba00df">Next</a></li></ul></div><article class="topic content-container" id="content-wrapper"><div id="topic-content" class="topic-content"><div class="breadcrumb-container"><ul class="breadcrumb"><li class="breadcrumb-link"> <span class="current-category">Sysdig Platform</span></li><li class="breadcrumb-link"><a href="43019-sysdig-platform.html">Sysdig Platform</a></li><li class="breadcrumb-link"><a href="43026-on-premises-deployments.html">On-Premises Deployments</a></li><li class="breadcrumb-link"><a href="43140-on-premises-upgrades.html">On-Premises Upgrades</a></li><li class="breadcrumb-node">Migration Tool for Unified Events (Platform v. 1149+)</li></ul></div><section xml:lang="en" dir="ltr" class="section original-topic lang-en original-topic" data-origin-id="UUID-c68c79a6-1c4e-2b5c-908e-ec924ac9b0f3" data-permalink="43144-migration-tool-for-unified-events--platform-v--1149--.html" data-topic-level="1" data-relative-prefix="" data-publication-date="" id="UUID-fe016e20-229b-e333-80ed-cb773dde4885"><div class="titlepage"><div><div class="title"><h1 class="title" style="clear: both">Migration Tool for Unified Events (Platform v. 1149+)</h1></div></div></div><p> <span class="bold bold"><strong>A</strong></span> <span class="bold bold"><strong>change was introduced in how events are indexed and stored</strong></span> in <a class="link" href="https://github.com/draios/sysdigcloud-kubernetes/releases/tag/v1149" target="_blank">version 1149</a> of the Sysdig platform.</p><p>Prior to this version, the three types of events were stored in three separate indexes, based on their different sources:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p> <span class="bold bold"><strong>Alert events</strong></span>: stored in MySQL (<code class="code">alert_notifications</code> table)</p></li><li class="listitem"><p> <span class="bold bold"><strong>Custom events</strong></span> (from both the infrastructure components and any custom event integrations): stored in ElasticSearch (<code class="code">events_v1</code> index)</p></li><li class="listitem"><p> <span class="bold bold"><strong>Policy events</strong></span> (from Sysdig Secure): stored in ElasticSearch (<code class="code">policy_event_v1</code> index)</p></li></ul></div><p>With version 1149 , they will be combined in one index.</p><p>The <span class="bold bold"><strong>Unified Events migration tool</strong></span> is delivered as a Docker container and is used to migrate events from multiple sources to a single source. When the migration and upgrade are complete, you manually terminate the migration tool.</p><div dir="ltr" class="warning warning"><h3 class="title">Warning</h3><p>It is highly recommended to run the migration tool BEFORE launching the upgrade to version 1149.</p><p>If you do not migrate before upgrading, you will lose visibility to old custom events in the Sysdig Monitor UI.</p></div><section xml:lang="en" dir="ltr" class="section xinclude lang-en xinclude" data-origin-id="" data-publication-date="" id="UUID-fe016e20-229b-e333-80ed-cb773dde4885_UUID-10a4178a-ada7-6842-4acb-9cbe4fba00df"><div class="titlepage"><div><div class="title"><h2 class="title" style="clear: both">Prerequisites</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p> <span class="bold bold"><strong>You must be running Sysdig platform</strong></span> <a class="link" href="https://github.com/draios/sysdigcloud-kubernetes/releases/tag/v1091" target="_blank"> <span class="bold bold"><strong>version</strong></span> <span class="bold bold"><strong>1091</strong></span> </a>. If your on-premises version is less than 1091, upgrade appropriately before running the migration tool.</p><div dir="ltr" class="warning warning"><h3 class="title">Warning</h3><p>It is highly recommended to follow upgrade best practices:</p><div class="itemizedlist"><ul style="list-style-type: circle; " class="itemizedlist"><li class="listitem"><p>Keep upgrades current</p></li><li class="listitem"><p>Upgrade progressively without skipping versions, and</p></li><li class="listitem"><p>Test upgrades in a non-mission-critical or staging environment before rolling in to production.</p></li></ul></div></div></li><li class="listitem"><p> <span class="bold bold"><strong>The migration tool container must have network visibility</strong></span> to the data sources used for re-indexing: MySQL and ElasticSearch.</p></li><li class="listitem"><p> <span class="bold bold"><strong>Launch migration before upgrading to version 1149. </strong></span> </p></li></ul></div></section><section xml:lang="en" dir="ltr" class="section xinclude lang-en xinclude" data-origin-id="" data-publication-date="" id="UUID-fe016e20-229b-e333-80ed-cb773dde4885_UUID-6aa9dbe1-0e0b-9efa-7edd-c94cc224ad0c"><div class="titlepage"><div><div class="title"><h2 class="title" style="clear: both">Where to Find the Tool</h2></div></div></div><p>The migration tool is provided as a containerized JavaApp on a public Quay repository. The Kubernetes and Replicated steps below give the precise location.</p></section><section xml:lang="en" dir="ltr" class="section xinclude lang-en xinclude" data-origin-id="" data-publication-date="" id="UUID-fe016e20-229b-e333-80ed-cb773dde4885_UUID-315818fc-a1d7-54c3-dd00-3afce634294c"><div class="titlepage"><div><div class="title"><h2 class="title" style="clear: both">Running the Migration</h2></div></div></div><p>Since events are constantly being generated, the migration tool executes the migration in batches. After each batch is indexed, the tool will try to fetch the next one, with a predefined cutoff.</p><p>When the tool finishes indexing old events and has begun to wait for new ones, the Sysdig application upgrade can be launched. In the background, during the upgrade, the tool ensures that incoming events in old indexes are properly reindexed to the new unified table.</p><p>The migration steps are:</p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>Run the container image.</p></li><li class="step"><p>Monitor the logs to see when old events have finished migrating.</p></li><li class="step"><p>Launch the upgrade.</p></li><li class="step"><p>Terminate the migration tool manually.</p></li></ol></div><p>Depending on your environment, follow the:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p> Kubernetes Steps </p></li><li class="listitem"><p> Replicated Steps </p></li></ul></div><section xml:lang="en" dir="ltr" class="section xinclude lang-en xinclude" data-origin-id="" data-publication-date="" id="UUID-fe016e20-229b-e333-80ed-cb773dde4885_UUID-e0e99d06-98eb-9e15-d561-f133a085649e"><div class="titlepage"><div><div class="title"><h3 class="title">Kubernetes Steps</h3></div></div></div><section dir="ltr" class="section internal internal" data-origin-id="" data-publication-date="" id="UUID-fe016e20-229b-e333-80ed-cb773dde4885_id_MigrationToolforUnifiedEventsPlatformv1149-1RuntheContainerImageK8s"><div class="titlepage"><div><div class="title"><h4 class="title">1. Run the Container Image (K8s)</h4></div></div></div><p>Run the following command:</p><pre class="programlisting">
kubectl -n sysdigcloud create -f MIGRATION_TOOL_SPECS.yaml</pre><p>Where <code class="code">MIGRATION_TOOL_SPECS</code> is defined as follows.</p><p>(You can obtain the <code class="code">.yaml</code> template from <a class="link" href="https://raw.githubusercontent.com/draios/sysdigcloud-kubernetes/master/scripts/events/migration_1091-1149/event-migration-tool_1091-1149.yaml" target="_blank">GitHub repository</a> or copy/paste it from this document. )</p><pre class="programlisting">---
apiVersion: v1
kind: Pod
metadata:
  labels:
    app: sysdigcloud
    role: event-migration
  name: sysdig-event-migration
spec:
  containers:
    - name: event-migration
      image: quay.io/sysdig/onprem_migration:combined-events_0.1.0_1091-1149
      env:
        - name: DB_ENDPOINT
          valueFrom:
            configMapKeyRef:
              name: sysdigcloud-config
              key: mysql.endpoint
        - name: DB_CONNECTION_TIMEOUT
          value: "4000" # Tweak parameter if necessary
        - name: DB_SOCKET_TIMEOUT
          value: "14000" # Tweak parameter if necessary
        - name: DB_USER
          valueFrom:
            configMapKeyRef:
              name: sysdigcloud-config
              key: mysql.user
        - name: DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: sysdigcloud-config
              key: mysql.password
        - name: ES_ENDPOINT
          valueFrom:
            configMapKeyRef:
              name: sysdigcloud-config
              key: elasticsearch.url
        - name: ES_PORT
          value: "9200" # Change this param if different
        - name: BATCH_SIZE
          value: "500"
        - name: ALERT_EVENTS
          value: "true"
        - name: CUSTOM_EVENTS
          value: "true"
        - name: POLICY_EVENTS
          value: "true"
        - name: ONPREM
          value: "true"
        - name: REPAIR_MODE
          value: "false"</pre><p>Sample logger output:</p><pre class="programlisting">
2018-07-26 10:42:49.129  INFO 8 --- [           main] com.sysdig.EventMigration                : Started EventMigration in 21.956 seconds (JVM running for 23.097)
2018-07-26 10:42:49.130  INFO 8 --- [           main] com.sysdig.EventMigration                : ====================== Onprem ======================
2018-07-26 10:42:49.131  INFO 8 --- [           main] com.sysdig.EventMigration                : * DB Settings
2018-07-26 10:42:49.131  INFO 8 --- [           main] com.sysdig.EventMigration                : * -- Connection Endpoint: mysql-master.staging.sysdigcloud.com
2018-07-26 10:42:49.131  INFO 8 --- [           main] com.sysdig.EventMigration                : * -- Connection Timeout: 4000
2018-07-26 10:42:49.131  INFO 8 --- [           main] com.sysdig.EventMigration                : * -- Socket Timeout: 15000
2018-07-26 10:42:49.132  INFO 8 --- [           main] com.sysdig.EventMigration                : * -- Username: admin
2018-07-26 10:42:49.132  INFO 8 --- [           main] com.sysdig.EventMigration                : * -- Password: *********
2018-07-26 10:42:49.132  INFO 8 --- [           main] com.sysdig.EventMigration                : *
2018-07-26 10:42:49.134  INFO 8 --- [           main] com.sysdig.EventMigration                : * ES Settings
2018-07-26 10:42:49.134  INFO 8 --- [           main] com.sysdig.EventMigration                : * -- Endpoint Url: http://localhost
2018-07-26 10:42:49.134  INFO 8 --- [           main] com.sysdig.EventMigration                : * -- Endpoint Port: 9200
2018-07-26 10:42:49.139  INFO 8 --- [           main] com.sysdig.EventMigration                : *
2018-07-26 10:42:49.139  INFO 8 --- [           main] com.sysdig.EventMigration                : * Migration Settings
2018-07-26 10:42:49.139  INFO 8 --- [           main] com.sysdig.EventMigration                : * -- Batch Size: 250
2018-07-26 10:42:49.139  INFO 8 --- [           main] com.sysdig.EventMigration                : *
2018-07-26 10:42:49.139  INFO 8 --- [           main] com.sysdig.EventMigration                : * Active Migrations
2018-07-26 10:42:49.140  INFO 8 --- [           main] com.sysdig.EventMigration                : * -- custom-events
2018-07-26 10:42:49.141  INFO 8 --- [           main] com.sysdig.EventMigration                : * -- alert-events
2018-07-26 10:42:49.141  INFO 8 --- [           main] com.sysdig.EventMigration                : * -- policy-events
2018-07-26 10:42:49.141  INFO 8 --- [           main] com.sysdig.EventMigration                : *
2018-07-26 10:42:49.141  INFO 8 --- [           main] com.sysdig.EventMigration                : * Migration is running in NORMAL mode
2018-07-26 10:42:49.141  INFO 8 --- [           main] com.sysdig.EventMigration                : ==================================================
2018-07-26 10:42:49.158  INFO 8 --- [           main] com.sysdig.services.MigrationService     : --- Executing alertEventMigration ---
2018-07-26 10:42:51.499  INFO 8 --- [           main] c.s.m.events.AlertEventMigration         : Starting from id 0
2018-07-26 10:42:51.681  INFO 8 --- [           main] c.s.m.events.AlertEventMigration         : Event count to be migrated: 8251</pre></section><section dir="ltr" class="section internal internal" data-origin-id="" data-publication-date="" id="UUID-fe016e20-229b-e333-80ed-cb773dde4885_id_MigrationToolforUnifiedEventsPlatformv1149-2WatchtheMigrationLogsK8s"><div class="titlepage"><div><div class="title"><h4 class="title">2. Watch the Migration Logs (K8s)</h4></div></div></div><p>Run a command to tail the logs so you can see when old events have finished migrating:</p><pre class="programlisting">
kubectl -n sysdigcloud logs -f sysdig-event-migration</pre><p>The tool will begin to migrate old events:</p><pre class="programlisting">
2018-07-25 09:58:50.806  INFO 7 --- [           main] c.s.m.events.AlertEventMigration         : Indexed 250 events; latest id is 133932
2018-07-25 09:58:52.343  INFO 7 --- [           main] c.s.m.events.AlertEventMigration         : Indexed 250 events; latest id is 134182
2018-07-25 09:58:54.091  INFO 7 --- [           main] c.s.m.events.AlertEventMigration         : Indexed 250 events; latest id is 134432
2018-07-25 09:58:56.114  INFO 7 --- [           main] c.s.m.events.AlertEventMigration         : Indexed 250 events; latest id is 134682
2018-07-25 09:58:57.776  INFO 7 --- [           main] c.s.m.events.AlertEventMigration         : Indexed 250 events; latest id is 134932
2018-07-25 09:58:59.161  INFO 7 --- [           main] c.s.m.events.AlertEventMigration         : Indexed 250 events; latest id is 135182
2018-07-25 09:59:00.649  INFO 7 --- [           main] c.s.m.events.AlertEventMigration         : Indexed 250 events; latest id is 135432
2018-07-25 09:59:01.994  INFO 7 --- [           main] c.s.m.events.AlertEventMigration         : Indexed 250 events; latest id is 135682</pre><p>When complete, it will be begin to check for new events in 1-minute intervals:</p><pre class="programlisting">
2018-07-25 09:59:44.206  INFO 7 --- [           main] c.s.m.events.AlertEventMigration         : No more alert_event to migrate...
2018-07-25 09:59:48.293  INFO 7 --- [           main] com.sysdig.services.MigrationService     : Let's sleep for 1 minute before continue</pre><p>At this point you can launch the upgrade to version 1149. The migration tool continues to run.</p></section><section dir="ltr" class="section internal internal" data-origin-id="" data-publication-date="" id="UUID-fe016e20-229b-e333-80ed-cb773dde4885_id_MigrationToolforUnifiedEventsPlatformv1149-3UpgradetheSysdigPlatformK8s"><div class="titlepage"><div><div class="title"><h4 class="title">3. Upgrade the Sysdig Platform (K8s)</h4></div></div></div><p>Check the <a class="link" href="https://sysdigdocs.atlassian.net/wiki/spaces/RN/overview" target="_blank">Release Notes</a>.</p><p>Follow the process to <a class="link" href="43162-basic-upgrade-kubernetes-installations.html" title="Basic Upgrade Kubernetes Installations">Basic Upgrade Kubernetes Installations</a>.</p><p>During upgrade, the tool will check periodically for new events.</p><p>Logger output:</p><pre class="programlisting">
2018-07-25 10:00:48.294  INFO 7 --- [           main] com.sysdig.services.MigrationService     : --- Checking for new events ---
2018-07-25 10:00:48.295  INFO 7 --- [           main] com.sysdig.services.MigrationService     : --- Executing alertEventMigration ---
2018-07-25 10:00:48.422  INFO 7 --- [           main] c.s.m.events.AlertEventMigration         : Starting from id 141933
2018-07-25 10:00:48.606  INFO 7 --- [           main] c.s.m.events.AlertEventMigration         : Event count to be migrated: 0
2018-07-25 10:00:48.731  INFO 7 --- [           main] c.s.m.events.AlertEventMigration         : No more alert_event to migrate...
2018-07-25 10:00:48.731  INFO 7 --- [           main] com.sysdig.services.MigrationService     : --- Executing policyEventMigration ---
2018-07-25 10:00:48.860  INFO 7 --- [           main] c.s.m.events.PolicyEventMigration        : Starting from id 567685605761232896
2018-07-25 10:00:49.168  INFO 7 --- [           main] c.s.m.events.PolicyEventMigration        : Event count to be migrated: 0
2018-07-25 10:00:49.484  INFO 7 --- [           main] c.s.m.events.PolicyEventMigration        : No more policy_event to migrate...
2018-07-25 10:00:49.484  INFO 7 --- [           main] com.sysdig.services.MigrationService     : --- Executing customEventMigration ---
2018-07-25 10:00:49.607  INFO 7 --- [           main] c.s.m.events.CustomEventMigration        : Starting from id 0
2018-07-25 10:00:49.882  INFO 7 --- [           main] c.s.m.events.CustomEventMigration        : Event count to be migrated: 0
2018-07-25 10:00:50.148  INFO 7 --- [           main] c.s.m.events.CustomEventMigration        : No more custom_event to migrate...
2018-07-25 10:00:50.148  INFO 7 --- [           main] com.sysdig.services.MigrationService     : Let's sleep for 1 minute before continue</pre></section><section dir="ltr" class="section internal internal" data-origin-id="" data-publication-date="" id="UUID-fe016e20-229b-e333-80ed-cb773dde4885_id_MigrationToolforUnifiedEventsPlatformv1149-4TerminatetheMigrationToolK8s"><div class="titlepage"><div><div class="title"><h4 class="title">4. Terminate the Migration Tool (K8s)</h4></div></div></div><p>When the Sysdig platform update is complete, <span class="bold bold"><strong>leave the migration tool running for at least 3 minutes.</strong></span> </p><p>To verify that the process is complete, check in the logs that custom events are no longer migrating. Sample output:</p><pre class="programlisting">
2018-07-25 10:00:49.484  INFO 7 --- [           main] com.sysdig.services.MigrationService     : --- Executing customEventMigration ---
2018-07-25 10:00:49.607  INFO 7 --- [           main] c.s.m.events.CustomEventMigration        : Starting from id 0
2018-07-25 10:00:49.882  INFO 7 --- [           main] c.s.m.events.CustomEventMigration        : Event count to be migrated: 0
2018-07-25 10:00:50.148  INFO 7 --- [           main] c.s.m.events.CustomEventMigration        : No more custom_event to migrate...</pre><p>Then terminate the migration tool by running the following command:</p><pre class="programlisting">
kubectl -n sysdigcloud delete -f {migration_tool_specs}.yaml</pre><p> <span class="bold bold"><strong>Migration and upgrade are complete.</strong></span> </p><p>If necessary, check the <span class="italic italic">Troubleshooting</span> tips, below.</p></section></section><section xml:lang="en" dir="ltr" class="section xinclude lang-en xinclude" data-origin-id="" data-publication-date="" id="UUID-fe016e20-229b-e333-80ed-cb773dde4885_UUID-7255d170-45c8-d72b-860c-d28c53b30456"><div class="titlepage"><div><div class="title"><h3 class="title">Replicated Steps</h3></div></div></div><p>If your environment is airgapped, you need to create an "image" of the migration tool that can be used on an airgapped install. Otherwise, proceed with  1. Run the Container Image.</p><section dir="ltr" class="section internal internal" data-origin-id="" data-publication-date="" id="UUID-fe016e20-229b-e333-80ed-cb773dde4885_id_MigrationToolforUnifiedEventsPlatformv1149-PrerequisiteforAirgappedEnvironments"><div class="titlepage"><div><div class="title"><h4 class="title">Prerequisite for Airgapped Environments</h4></div></div></div><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>Pull the image onto a host that has access to the Internet:</p><pre class="programlisting">
docker pull quay.io/sysdig/onprem_migration:combined-events_0.1.0_1091-1149</pre></li><li class="step"><p>Save the downloaded image to a TAR file:</p><pre class="programlisting">
docker save -o migrate.tar quay.io/sysdig/onprem_migration</pre></li><li class="step"><p>Move the image TAR to the airgapped machine and deploy the image:</p><pre class="programlisting">docker load -i migrate.tar</pre></li></ol></div><p>Continue with the Replicated steps, below.</p></section><section dir="ltr" class="section internal internal" data-origin-id="" data-publication-date="" id="UUID-fe016e20-229b-e333-80ed-cb773dde4885_id_MigrationToolforUnifiedEventsPlatformv1149-1RuntheContainerImageReplicated"><div class="titlepage"><div><div class="title"><h4 class="title">1. Run the Container Image (Replicated)</h4></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Ensure that the container has network visibility to the MySQL and ElasticSearch components.</p></li><li class="listitem"><p>Run the migration tool container on a Coordinating Replicated Node, and run the container using the private addresses of data source endpoints.</p><div dir="ltr" class="note note"><h3 class="title">Note</h3><p>The data source endpoints can be found on the Replicated Dashboard, in <span class="bold bold"><strong>Cluster</strong></span> settings.</p><p>Other parameters, such as DB usernames, can be found in the <span class="bold bold"><strong>Settings</strong></span> section of the Replicated Dashboard console.</p><p> <span class="bold bold"><strong> NOTE:</strong></span> The MySQL password was set when the Sysdig back end was <a class="link" href="">installed using Replicated</a>. The administrator needed to save and remember the DB passwords that were set, as they are not visible in the Replicated console.</p><div class="mediaobject"><table style="border: 0; width: 600px; cellpadding: 0; cellspacing: 0;" class="image-viewport"><tr><td><img style="max-width: 600px; " src="image/uuid-11b9fdf1-20cd-7f7f-44e5-7654857aacee-en.png" alt="373573554.png"></img></td></tr></table></div></div></li></ul></div><p>Execute the following Docker run command, providing the values described in the Appendix - Migration Tool Container Parameters.</p><p>In Docker command format:</p><pre class="programlisting">
docker run -d --name sysdig-event-migration -e DB_ENDPOINT=10.111.0.1 -e DB_CONNECTION_TIMEOUT=4000 -e DB_SOCKET_TIMEOUT=12000 -e DB_USER=root -e DB_PASSWORD=&lt;password&gt; -e BATCH_SIZE=350 -e ES_ENDPOINT=http://10.111.0.1 -e ALERT_EVENTS=true -e CUSTOM_EVENTS=true -e POLICY_EVENTS=true -e REPAIR_MODE=false -e ONPREM=true quay.io/sysdig/onprem_migration:combined-events_0.1.0_1091-1149</pre><p>With annotations for</p><pre class="programlisting">docker run -d --name sysdig-event-migration \
    -e DB_ENDPOINT=&lt;mysql_url&gt; \                                                                    # &lt;mysql_url&gt; should be address without protocol defined (e.g. without 'http://')
    -e DB_CONNECTION_TIMEOUT=&lt;connection_timeout&gt; \
    -e DB_SOCKET_TIMEOUT=&lt;socket_timeout&gt; \
    -e DB_USER=&lt;user_name&gt; \
    -e DB_PASSWORD=&lt;password&gt; \
    -e BATCH_SIZE=&lt;batch_size&gt; \
    -e ES_ENDPOINT=&lt;elasticsearch_endpoint&gt; \                                                # &lt;elasticsearch_endpoint&gt; should be address with protocol defined (e.g.with 'http://')
    -e ES_PORT=&lt;elasticsearch_port&gt; \                                                                # Default port is 9200, needs to be changed in case of custom value
    -e ALERT_EVENTS=true \
    -e CUSTOM_EVENTS=true \
    -e POLICY_EVENTS=true \
    -e REPAIR_MODE=false \
    -e ONPREM=true \
    quay.io/sysdig/onprem_migration:combined-events_0.1.0_1091-1149     </pre><p>Sample logger output:</p><pre class="programlisting">
2018-07-26 10:42:49.129  INFO 8 --- [           main] com.sysdig.EventMigration                : Started EventMigration in 21.956 seconds (JVM running for 23.097)
2018-07-26 10:42:49.130  INFO 8 --- [           main] com.sysdig.EventMigration                : ====================== Onprem ======================
2018-07-26 10:42:49.131  INFO 8 --- [           main] com.sysdig.EventMigration                : * DB Settings
2018-07-26 10:42:49.131  INFO 8 --- [           main] com.sysdig.EventMigration                : * -- Connection Endpoint: mysql-master.staging.sysdigcloud.com
2018-07-26 10:42:49.131  INFO 8 --- [           main] com.sysdig.EventMigration                : * -- Connection Timeout: 4000
2018-07-26 10:42:49.131  INFO 8 --- [           main] com.sysdig.EventMigration                : * -- Socket Timeout: 15000
2018-07-26 10:42:49.132  INFO 8 --- [           main] com.sysdig.EventMigration                : * -- Username: admin
2018-07-26 10:42:49.132  INFO 8 --- [           main] com.sysdig.EventMigration                : * -- Password: *********
2018-07-26 10:42:49.132  INFO 8 --- [           main] com.sysdig.EventMigration                : *
2018-07-26 10:42:49.134  INFO 8 --- [           main] com.sysdig.EventMigration                : * ES Settings
2018-07-26 10:42:49.134  INFO 8 --- [           main] com.sysdig.EventMigration                : * -- Endpoint Url: http://localhost
2018-07-26 10:42:49.134  INFO 8 --- [           main] com.sysdig.EventMigration                : * -- Endpoint Port: 9200
2018-07-26 10:42:49.139  INFO 8 --- [           main] com.sysdig.EventMigration                : *
2018-07-26 10:42:49.139  INFO 8 --- [           main] com.sysdig.EventMigration                : * Migration Settings
2018-07-26 10:42:49.139  INFO 8 --- [           main] com.sysdig.EventMigration                : * -- Batch Size: 250
2018-07-26 10:42:49.139  INFO 8 --- [           main] com.sysdig.EventMigration                : *
2018-07-26 10:42:49.139  INFO 8 --- [           main] com.sysdig.EventMigration                : * Active Migrations
2018-07-26 10:42:49.140  INFO 8 --- [           main] com.sysdig.EventMigration                : * -- custom-events
2018-07-26 10:42:49.141  INFO 8 --- [           main] com.sysdig.EventMigration                : * -- alert-events
2018-07-26 10:42:49.141  INFO 8 --- [           main] com.sysdig.EventMigration                : * -- policy-events
2018-07-26 10:42:49.141  INFO 8 --- [           main] com.sysdig.EventMigration                : *
2018-07-26 10:42:49.141  INFO 8 --- [           main] com.sysdig.EventMigration                : * Migration is running in NORMAL mode
2018-07-26 10:42:49.141  INFO 8 --- [           main] com.sysdig.EventMigration                : ==================================================
2018-07-26 10:42:49.158  INFO 8 --- [           main] com.sysdig.services.MigrationService     : --- Executing alertEventMigration ---
2018-07-26 10:42:51.499  INFO 8 --- [           main] c.s.m.events.AlertEventMigration         : Starting from id 0
2018-07-26 10:42:51.681  INFO 8 --- [           main] c.s.m.events.AlertEventMigration         : Event count to be migrated: 8251</pre></section><section dir="ltr" class="section internal internal" data-origin-id="" data-publication-date="" id="UUID-fe016e20-229b-e333-80ed-cb773dde4885_id_MigrationToolforUnifiedEventsPlatformv1149-2WatchtheMigrationLogsReplicated"><div class="titlepage"><div><div class="title"><h4 class="title">2. Watch the Migration Logs (Replicated)</h4></div></div></div><p>Run a command to tail the logs so you can see when old events have finished migrating:</p><pre class="programlisting">docker logs -f sysdig-event-migration</pre><p>The tool will begin to migrate old events:</p><pre class="programlisting">
2018-07-25 09:58:50.806  INFO 7 --- [           main] c.s.m.events.AlertEventMigration         : Indexed 250 events; latest id is 133932
2018-07-25 09:58:52.343  INFO 7 --- [           main] c.s.m.events.AlertEventMigration         : Indexed 250 events; latest id is 134182
2018-07-25 09:58:54.091  INFO 7 --- [           main] c.s.m.events.AlertEventMigration         : Indexed 250 events; latest id is 134432
2018-07-25 09:58:56.114  INFO 7 --- [           main] c.s.m.events.AlertEventMigration         : Indexed 250 events; latest id is 134682
2018-07-25 09:58:57.776  INFO 7 --- [           main] c.s.m.events.AlertEventMigration         : Indexed 250 events; latest id is 134932
2018-07-25 09:58:59.161  INFO 7 --- [           main] c.s.m.events.AlertEventMigration         : Indexed 250 events; latest id is 135182
2018-07-25 09:59:00.649  INFO 7 --- [           main] c.s.m.events.AlertEventMigration         : Indexed 250 events; latest id is 135432
2018-07-25 09:59:01.994  INFO 7 --- [           main] c.s.m.events.AlertEventMigration         : Indexed 250 events; latest id is 135682</pre><p>When complete, it will be begin to check for new events in 1-minute intervals:</p><pre class="programlisting">
2018-07-25 09:59:44.206  INFO 7 --- [           main] c.s.m.events.AlertEventMigration         : No more alert_event to migrate...
2018-07-25 09:59:48.293  INFO 7 --- [           main] com.sysdig.services.MigrationService     : Let's sleep for 1 minute before continue</pre><p>At this point you can launch the upgrade to version 1149. The migration tool continues to run.</p></section><section dir="ltr" class="section internal internal" data-origin-id="" data-publication-date="" id="UUID-fe016e20-229b-e333-80ed-cb773dde4885_id_MigrationToolforUnifiedEventsPlatformv1149-3UpgradetheSysdigPlatformReplicated"><div class="titlepage"><div><div class="title"><h4 class="title">3. Upgrade the Sysdig Platform (Replicated)</h4></div></div></div><p>Check the <a class="link" href="https://sysdigdocs.atlassian.net/wiki/spaces/RN/overview" target="_blank">Release Notes</a>.</p><p>Follow the process to <a class="link" href="43202-upgrade-replicated-installations.html" title="Upgrade Replicated Installations">Upgrade Replicated Installations</a>.</p><p>During upgrade, the tool will check periodically for new events.</p><div dir="ltr" class="note note"><h3 class="title">Note</h3><p>In Replicated, the upgrade requires ElasticSearch and MySQL servers to be restarted, so you will experience connection loss during upgrade. The migration tool is designed to handle this gracefully, so connection loss <code class="code">WARN</code> messages in logs are expected and not a problem with the migration.</p></div><p>Replicated logger output (note the WARN messages):</p><pre class="programlisting">...
2018-08-07 12:24:19.659  INFO 8 --- [           main] c.s.m.events.AlertEventMigration         : Indexed 300 events; latest id is 1600306
2018-08-07 12:24:34.703  INFO 8 --- [           main] o.s.b.f.xml.XmlBeanDefinitionReader      : Loading XML bean definitions from class path resource [org/springframework/jdbc/support/sql-error-codes.xml]
2018-08-07 12:24:34.813  INFO 8 --- [           main] o.s.jdbc.support.SQLErrorCodesFactory    : SQLErrorCodes loaded: [DB2, Derby, H2, HDB, HSQL, Informix, MS-SQL, MySQL, Oracle, PostgreSQL, Sybase]
2018-08-07 12:24:39.182  WARN 8 --- [           main] com.sysdig.services.MigrationService     : Connection with MySQL has been lost: Communications link failure
2018-08-07 12:24:40.803  INFO 8 --- [           main] com.sysdig.services.MigrationService     : Let's sleep for 1 minute before continue
2018-08-07 12:25:40.734  INFO 8 --- [           main] com.sysdig.services.MigrationService     : --- Checking for events to migrate ---
2018-08-07 12:25:40.736  INFO 8 --- [           main] com.sysdig.services.MigrationService     : --- Executing alertEventMigration ---
2018-08-07 12:25:41.000  INFO 8 --- [           main] c.s.m.events.AlertEventMigration         : Starting from id 1600306
2018-08-07 12:25:41.363  INFO 8 --- [           main] c.s.m.events.AlertEventMigration         : Event count to be migrated: 455573
2018-08-07 12:25:42.106  WARN 8 --- [           main] com.sysdig.services.MigrationService     : Connection with ES has been lost: Could not connect to http://host.docker.internal:9200
2018-08-07 12:25:42.107  INFO 8 --- [           main] com.sysdig.services.MigrationService     : --- Executing policyEventMigration ---
2018-08-07 12:25:42.240  INFO 8 --- [           main] c.s.m.events.PolicyEventMigration        : Starting from id 0
2018-08-07 12:25:42.243  WARN 8 --- [           main] c.s.m.events.PolicyEventMigration        : Error during data fetch from ES, due to: Could not connect to http://host.docker.internal:9200
2018-08-07 12:25:42.246  WARN 8 --- [           main] com.sysdig.services.MigrationService     : Connection with ES has been lost: Could not connect to http://host.docker.internal:9200
2018-08-07 12:25:42.247  INFO 8 --- [           main] com.sysdig.services.MigrationService     : --- Executing customEventMigration ---
2018-08-07 12:25:42.384  INFO 8 --- [           main] c.s.m.events.CustomEventMigration        : Starting from id 569942131465043968
2018-08-07 12:25:42.386  WARN 8 --- [           main] c.s.m.events.CustomEventMigration        : Error during data fetch from ES, due to: Could not connect to http://host.docker.internal:9200
2018-08-07 12:25:42.389  WARN 8 --- [           main] com.sysdig.services.MigrationService     : Connection with ES has been lost: Could not connect to http://host.docker.internal:9200
2018-08-07 12:25:42.389  INFO 8 --- [           main] com.sysdig.services.MigrationService     : Let's sleep for 1 minute before continue   
2018-08-07 12:26:42.320  INFO 8 --- [           main] com.sysdig.services.MigrationService     : --- Checking for events to migrate ---
2018-08-07 12:26:42.321  INFO 8 --- [           main] com.sysdig.services.MigrationService     : --- Executing alertEventMigration ---
2018-08-07 12:26:42.584  INFO 8 --- [           main] c.s.m.events.AlertEventMigration         : Starting from id 1600306
2018-08-07 12:26:42.923  INFO 8 --- [           main] c.s.m.events.AlertEventMigration         : Event count to be migrated: 455578
2018-08-07 12:26:44.404  INFO 8 --- [           main] c.s.m.events.AlertEventMigration         : Indexed 300 events; latest id is 1600606
</pre></section><section dir="ltr" class="section internal internal" data-origin-id="" data-publication-date="" id="UUID-fe016e20-229b-e333-80ed-cb773dde4885_id_MigrationToolforUnifiedEventsPlatformv1149-4TerminatetheMigrationToolReplicated"><div class="titlepage"><div><div class="title"><h4 class="title">4. Terminate the Migration Tool (Replicated)</h4></div></div></div><p>When the Sysdig platform update is complete, <span class="bold bold"><strong>leave the migration tool running for at least 3 minutes.</strong></span> </p><p>To verify that the process is complete, check in the logs that custom events are no longer migrating.</p><p>Sample output:</p><pre class="programlisting">
2018-07-25 10:00:49.484  INFO 7 --- [           main] com.sysdig.services.MigrationService     : --- Executing customEventMigration ---
2018-07-25 10:00:49.607  INFO 7 --- [           main] c.s.m.events.CustomEventMigration        : Starting from id 0
2018-07-25 10:00:49.882  INFO 7 --- [           main] c.s.m.events.CustomEventMigration        : Event count to be migrated: 0
2018-07-25 10:00:50.148  INFO 7 --- [           main] c.s.m.events.CustomEventMigration        : No more custom_event to migrate...</pre><p>Then terminate the migration tool, by running the following command:</p><pre class="programlisting">docker stop sysdig-event-migration
docker rm sysdig-event-migration</pre><p> <span class="bold bold"><strong>Migration and upgrade are complete.</strong></span> </p><p>If necessary, check the <span class="italic italic">Troubleshooting </span>tips, below.</p></section></section></section><section xml:lang="en" dir="ltr" class="section xinclude lang-en xinclude" data-origin-id="" data-publication-date="" id="UUID-fe016e20-229b-e333-80ed-cb773dde4885_UUID-9bf0427e-8f2d-325f-addd-2924751dd22e"><div class="titlepage"><div><div class="title"><h2 class="title" style="clear: both">Troubleshooting</h2></div></div></div><p>In rare cases, migration errors can occur due to incorrect container configuration, network latency, or temporary cluster overload.</p><div dir="ltr" class="note note"><h3 class="title">Note</h3><p>Temporary connection-loss errors in Replicated are expected and are not migration errors, as described in Upgrade the Sysdig Platform (Replicated) </p></div><section xml:lang="en" dir="ltr" class="section xinclude lang-en xinclude" data-origin-id="" data-publication-date="" id="UUID-fe016e20-229b-e333-80ed-cb773dde4885_UUID-22374cfe-cd43-a010-e1c7-225350a90d53"><div class="titlepage"><div><div class="title"><h3 class="title">Migration Startup Errors</h3></div></div></div><p>Startup errors are normally due to incorrect environment variable settings.</p><p>Check URL endpoints, passed credentials, flags, etc.</p></section><section xml:lang="en" dir="ltr" class="section xinclude lang-en xinclude" data-origin-id="" data-publication-date="" id="UUID-fe016e20-229b-e333-80ed-cb773dde4885_UUID-e26a2713-2262-fc1c-c5be-f6d15814671a"><div class="titlepage"><div><div class="title"><h3 class="title">Migration Process Errors</h3></div></div></div><p>If you were able to run migration successfully, it functioned for a while, and then began to experience errors, this is most likely caused by network latency or cluster overload. In these cases, the migration tool will try to reduce the pressure on the cluster by reducing batch size exponentially, with a predefined backoff wait time.</p><p>Ultimately, if events cannot be indexed, the migration tool will skip the issued batch and try to index the next batch. Information about the failed batch will be stored in the MySQL table <code class="code">utility_metadata</code>.</p><section dir="ltr" class="section internal internal" data-origin-id="" data-publication-date="" id="UUID-fe016e20-229b-e333-80ed-cb773dde4885_id_MigrationToolforUnifiedEventsPlatformv1149-TemporaryErrors"><div class="titlepage"><div><div class="title"><h4 class="title">Temporary Errors</h4></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>If errors are only temporary, simply proceed with <span class="italic italic">Running the Migration Steps</span>.</p></li><li class="listitem"><p>When migration is complete, run the migration container again with the <code class="code"> -e REPAIR_MODE=true</code> parameter. This will index all failed migrations stored in the MySQL table <code class="code">utility_metadata</code>.</p></li></ul></div></section><section dir="ltr" class="section internal internal" data-origin-id="" data-publication-date="" id="UUID-fe016e20-229b-e333-80ed-cb773dde4885_id_MigrationToolforUnifiedEventsPlatformv1149-ContinuousErrors"><div class="titlepage"><div><div class="title"><h4 class="title">Continuous Errors</h4></div></div></div><p>At this point, abort the migration attempt. Check the number of errors to decide how to proceed.</p><p>To do so, check the MySQL table with:</p><pre class="programlisting">
SELECT COUNT(*) FROM utility_metadata WHERE metadata_id LIKE 'failure-%';</pre><section dir="ltr" class="section internal internal" data-origin-id="" data-publication-date="" id="UUID-fe016e20-229b-e333-80ed-cb773dde4885_id_MigrationToolforUnifiedEventsPlatformv1149-LOWErrorCount0-1000"><div class="titlepage"><div><div class="title"><h5 class="title">LOW Error Count (0 - 1000)</h5></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Try to identify why errors started (i.e. temporary cluster overload), resolve the problem and re-run the migration.</p></li><li class="listitem"><p>When migration is complete, run the migration container again with the <code class="code"> -e REPAIR_MODE=true</code> parameter. This will index all failed migrations stored in the MySQL table <code class="code">utility_metadata.</code> </p></li></ul></div></section><section dir="ltr" class="section internal internal" data-origin-id="" data-publication-date="" id="UUID-fe016e20-229b-e333-80ed-cb773dde4885_id_MigrationToolforUnifiedEventsPlatformv1149-HIGHErrorCount10000"><div class="titlepage"><div><div class="title"><h5 class="title">HIGH Error Count (10,000+)</h5></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Try to identify why errors started (i.e. temporary cluster overload), resolve the problem, and <span class="bold bold"><strong>RESET</strong></span> the migration progress completely by clearing all content from the MySQL table <code class="code">utility_metadata</code>.</p><p>(e.g. <code class="code">DELETE FROM utility_metadata;</code>)</p></li><li class="listitem"><p>Repeat <span class="italic italic">Running the Migration Steps.</span> </p></li></ul></div></section></section></section></section><section xml:lang="en" dir="ltr" class="section xinclude lang-en xinclude" data-origin-id="" data-publication-date="" id="UUID-fe016e20-229b-e333-80ed-cb773dde4885_UUID-173b73dc-bdcc-f36c-9129-effc37746e6c"><div class="titlepage"><div><div class="title"><h2 class="title" style="clear: both">Appendix - Migration Tool Container Parameters</h2></div></div></div><p>All parameters are defined as environment variables.</p><div class="informaltable table-responsive"><table class="informaltable frame-void rules-rows"><colgroup><col></col><col></col><col></col><col></col><col></col><col></col></colgroup><thead><tr><th class="th"><p>Env Param</p></th><th class="th"><p>Required</p></th><th class="th"><p>Type</p></th><th class="th"><p>Description</p></th><th class="th"><p>Example</p></th><th class="th"><p>Recommended values</p></th></tr></thead><tbody><tr><td class="td"><p> <span class="bold bold"><strong>DB_ENDPOINT</strong></span> </p></td><td class="td"><p>true</p></td><td class="td"><p>string</p></td><td class="td"><p>Defined database connection endpoint</p></td><td class="td"><p> <a class="link" href="http://MYSQLURL.com" target="_blank">MYSQLURL.com</a> </p></td><td class="td"><p>Do NOT include the protocol (e.g. <span class="bold bold"><strong>https://</strong></span>) in the endpoint entry</p></td></tr><tr><td class="td"><p> <span class="bold bold"><strong>DB_CONNECTION_TIMEOUT</strong></span> </p></td><td class="td"><p>false</p></td><td class="td"><p>int</p></td><td class="td"><p>Defined connection timeout period</p></td><td class="td"><p>5000</p></td><td class="td"><p>Default value if not set is <code class="code">5000</code> </p></td></tr><tr><td class="td"><p> <span class="bold bold"><strong>DB_SOCKET_TIMEOUT</strong></span> </p></td><td class="td"><p>false</p></td><td class="td"><p>int</p></td><td class="td"><p>Defined socket timeout period</p></td><td class="td"><p>300000</p></td><td class="td"><p>Default value if not set is <code class="code">30000</code> </p></td></tr><tr><td class="td"><p> <span class="bold bold"><strong>DB_USER</strong></span> </p></td><td class="td"><p>true</p></td><td class="td"><p>string</p></td><td class="td"><p>Defined database username</p></td><td class="td"><p>root</p></td><td class="td"><p>/</p></td></tr><tr><td class="td"><p> <span class="bold bold"><strong>DB_PASSWORD</strong></span> </p></td><td class="td"><p>false</p></td><td class="td"><p>string</p></td><td class="td"><p>Defined database password</p></td><td class="td"><p>pass</p></td><td class="td"><p>/</p></td></tr><tr><td class="td"><p> <span class="bold bold"><strong>ES_ENDPOINT</strong></span> </p></td><td class="td"><p>true</p></td><td class="td"><p>string</p></td><td class="td"><p>ElasticSearch endpoint</p></td><td class="td"><p> <a class="link" href="http://MYELASTICSEARCHURL.com" target="_blank">http://MYELASTICSEARCHURL.com</a> </p></td><td class="td"><p>Include the protocol (e.g <span class="bold bold"><strong>http://</strong></span>) in the endpoint entry</p></td></tr><tr><td class="td"><p> <span class="bold bold"><strong>ES_PORT</strong></span> </p></td><td class="td"><p>false</p></td><td class="td"><p>int</p></td><td class="td"><p>ElasticSearch port</p></td><td class="td"><p>9200</p></td><td class="td"><p>If there is no LB in front of the cluster it should be <code class="code">9200</code> </p></td></tr><tr><td class="td"><p> <span class="bold bold"><strong>BATCH_SIZE</strong></span> </p></td><td class="td"><p>false</p></td><td class="td"><p>int</p></td><td class="td"><p>Size of indexing event batch</p></td><td class="td"><p>500</p></td><td class="td"><p>Default value if not set is <code class="code">500</code> </p></td></tr><tr><td class="td"><p> <span class="bold bold"><strong>ALERT_EVENTS</strong></span> </p></td><td class="td"><p>one of</p></td><td class="td"><p>boolean</p></td><td rowspan="3" class="td"><p>Simple options that specify which migrations should be executed.</p><p> <span class="bold bold"><strong>At least one of them must be provided</strong></span> </p></td><td rowspan="3" class="td"><p>/</p></td><td rowspan="3" class="td"><p>Default value if not set is <code class="code">false</code> </p></td></tr><tr><td class="td"><p> <span class="bold bold"><strong>CUSTOM_EVENTS</strong></span> </p></td><td class="td"><p>one of</p></td><td class="td"><p>boolean</p></td></tr><tr><td class="td"><p> <span class="bold bold"><strong>POLICY_EVENTS</strong></span> </p></td><td class="td"><p>one of</p></td><td class="td"><p>boolean</p></td></tr><tr><td class="td"><p> <span class="bold bold"><strong>ONPREM</strong></span> </p></td><td class="td"><p>false</p></td><td class="td"><p>boolean</p></td><td class="td"><p>Specify whether this is migration executed in on-premise environment</p></td><td class="td"><p>true</p></td><td class="td"><p>All onpremise migrations should have this option set to <span class="bold bold"><strong> <code class="code">true</code>;</strong></span> default <code class="code">false</code> </p></td></tr><tr><td class="td"><p> <span class="bold bold"><strong>REPAIR_MODE</strong></span> </p></td><td class="td"><p>false</p></td><td class="td"><p>boolean</p></td><td class="td"><p>Specify that migration will be running repair mode</p></td><td class="td"><p>true</p></td><td class="td"><p>This should be only used in case of errors during migrations (explained in following sections), default <code class="code">false</code> </p></td></tr></tbody></table></div></section></section><div class="footer-content"><div class="glossary-definitions"></div></div><footer></footer></div></article><aside class="section-nav-container"><ul class="section-nav nav"><li><a href="#UUID-fe016e20-229b-e333-80ed-cb773dde4885">Migration Tool for Unified Events (Platform v. 1149+)</a></li><li><a href="#UUID-fe016e20-229b-e333-80ed-cb773dde4885_UUID-10a4178a-ada7-6842-4acb-9cbe4fba00df">Prerequisites</a></li><li><a href="#UUID-fe016e20-229b-e333-80ed-cb773dde4885_UUID-6aa9dbe1-0e0b-9efa-7edd-c94cc224ad0c">Where to Find the Tool</a></li><li><a href="#UUID-fe016e20-229b-e333-80ed-cb773dde4885_UUID-315818fc-a1d7-54c3-dd00-3afce634294c">Running the Migration</a><ul class="nav"><li><a href="#UUID-fe016e20-229b-e333-80ed-cb773dde4885_UUID-e0e99d06-98eb-9e15-d561-f133a085649e">Kubernetes Steps</a><ul class="nav"></ul></li><li><a href="#UUID-fe016e20-229b-e333-80ed-cb773dde4885_UUID-7255d170-45c8-d72b-860c-d28c53b30456">Replicated Steps</a><ul class="nav"></ul></li></ul></li><li><a href="#UUID-fe016e20-229b-e333-80ed-cb773dde4885_UUID-9bf0427e-8f2d-325f-addd-2924751dd22e">Troubleshooting</a><ul class="nav"><li><a href="#UUID-fe016e20-229b-e333-80ed-cb773dde4885_UUID-22374cfe-cd43-a010-e1c7-225350a90d53">Migration Startup Errors</a></li><li><a href="#UUID-fe016e20-229b-e333-80ed-cb773dde4885_UUID-e26a2713-2262-fc1c-c5be-f6d15814671a">Migration Process Errors</a><ul class="nav"></ul></li></ul></li><li><a href="#UUID-fe016e20-229b-e333-80ed-cb773dde4885_UUID-173b73dc-bdcc-f36c-9129-effc37746e6c">Appendix - Migration Tool Container Parameters</a></li></ul></aside><article id="search-result-wrapper"><div class="search-container" style="display: none;"><h2>Search results</h2><ul class="searchresults"></ul><p class="noresults">No results found</p></div></article><div class="feedback-panel"><div class="voting-title">Was this helpful?</div><div class="btn-group btn-group-toggle" data-toggle="buttons"><button id="feedback-yes-btn" class="btn toggle-yes">Yes</button><button id="feedback-no-btn" class="btn">No</button></div><div id="email-feedback" class=" toggle-feedback"><p><a href='mailto:radhika@sysdig.com?subject=Feedback for help topic "Migration Tool for Unified Events (Platform v. 1149+)"&amp;body=%0D%0A_______________________%0D%0A%0D%0A
			
			Please add your feedback above for topic "Migration Tool for Unified Events (Platform v. 1149+)" in the publication "Sysdig Platform".'><i aria-hidden="true" class="fa fa-pencil-square-o feedbackicon voting-feedbackicon"></i>Would you like to provide feedback? Just click here to suggest edits.</a></p></div></div></main><div id="bottom-pager"><ul class="pager"><li class="previous"><a accesskey="p" id="header-navigation-prev" class="pull-left prev visible-lg visible-md" href="43140-on-premises-upgrades.html#UUID-360704d7-d3e0-7169-b074-f1990f6603ef_UUID-0012eee4-642c-c9dd-5b8c-9498c30246b2">Prev</a></li><li class="next"><a accesskey="n" id="header-navigation-next" class="pull-right next visible-lg visible-md" href="43144-migration-tool-for-unified-events--platform-v--1149--.html#UUID-fe016e20-229b-e333-80ed-cb773dde4885_UUID-10a4178a-ada7-6842-4acb-9cbe4fba00df">Next</a></li></ul></div><footer class="site-footer"><div class="inner"><div class="copyright"> © 2019 Sysdig </div><div class="publication-date"><span class="publication-date-text">Publication date</span><span class="pubdate-delimiter">: </span><span class="formatted-date"></span></div></div></footer></div></div></div></div></body></html>
